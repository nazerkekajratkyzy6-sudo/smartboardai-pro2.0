<!doctype html>
<html lang="kk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>3D Geometry Mission (KZ) ‚Äî –°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ (–æ—Ñ–ª–∞–π–Ω)</title>
  <style>
    :root{
      --bg:#f7f9ff;
      --ink:#172048;
      --muted:#5a668f;
      --card:#ffffff;
      --line:rgba(23,32,72,.12);
      --shadow: 0 16px 40px rgba(22,28,60,.10);
      --ok:#10b981;
      --bad:#ef476f;
      --warn:#f59e0b;
      --accent:#6366f1;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--ink);
      background:
        radial-gradient(900px 650px at 12% 10%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(900px 650px at 88% 14%, rgba(16,185,129,.14), transparent 60%),
        radial-gradient(900px 650px at 50% 92%, rgba(245,158,11,.12), transparent 60%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(247,249,255,.82);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:0 16px}
    .top{display:flex;gap:12px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;padding:14px 0}
    h1{margin:0;font-size:18px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;padding:14px 0 28px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92));
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(23,32,72,.16);
      background:#fff;
      color:var(--ink);
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .btn{
      cursor:pointer; user-select:none;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(23,32,72,.14);
      background:linear-gradient(180deg,#fff,#eef2ff);
      color:var(--ink);
      transition:transform .12s ease, filter .12s ease;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.02)}
    .btn:active{transform:translateY(0);filter:brightness(.99)}
    .btn.ok{border-color:rgba(16,185,129,.40)}
    .btn.bad{border-color:rgba(239,71,111,.40)}
    .btn.warn{border-color:rgba(245,158,11,.45)}
    .pill{
      font-size:12px;
      border:1px solid rgba(23,32,72,.14);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      background:#fff;
    }
    .pill.ok{border-color:rgba(16,185,129,.45); color:rgba(16,185,129,.95)}
    .pill.bad{border-color:rgba(239,71,111,.45); color:rgba(239,71,111,.95)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .muted{color:var(--muted);font-size:13px}
    .small{color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:720px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .box{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff}
    .kpi .n{font-weight:900;font-size:18px}
    .kpi .t{font-size:12px;color:var(--muted)}
    canvas{width:100%;height:420px;border-radius:14px;border:1px solid var(--line);background:#ffffff}
    @media(max-width:980px){canvas{height:360px}}
    .hint{border:1px dashed rgba(99,102,241,.35); background:rgba(99,102,241,.05); padding:10px;border-radius:14px}
    details{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
    summary{cursor:pointer}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);
      padding:10px 12px;border-radius:999px;font-size:13px;display:none;z-index:99;
    }
    .tag{display:inline-flex;gap:8px;align-items:center;font-size:12px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;color:var(--muted)}
    .legend{display:flex;gap:8px;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;border:1px solid rgba(23,32,72,.22)}
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div>
      <h1>3D Geometry Mission ‚Äî –°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä–∏—è (10‚Äì11 —Å—ã–Ω—ã–ø —Å—Ç–∏–ª—ñ) ¬∑ –û—Ñ–ª–∞–π–Ω HTML</h1>
      <div class="sub">–ê—à—ã“õ —Ñ–æ–Ω ¬∑ 3D –∞–π–Ω–∞–ª–¥—ã—Ä—É (drag) ¬∑ –¢“Ø–∑—É/–∂–∞–∑—ã“õ—Ç—ã“õ —Ç–∞“£–¥–∞—É ¬∑ –ë“±—Ä—ã—à/“õ–∞—à—ã“õ—Ç—ã“õ ”©–ª—à–µ—É ¬∑ –°–æ“£—ã–Ω–¥–∞ —Ç–∞–ª–¥–∞—É</div>
    </div>
    <div class="row" style="align-items:center">
      <span class="tag"><span class="dot" style="background:rgba(99,102,241,.55)"></span>–ù“Ø–∫—Ç–µ</span>
      <span class="tag"><span class="dot" style="background:rgba(16,185,129,.55)"></span>–¢–∞“£–¥–∞–ª“ì–∞–Ω</span>
      <span class="tag"><span class="dot" style="background:rgba(245,158,11,.55)"></span>”®–ª—à–µ–º</span>
    </div>
  </div>
</header>

<div class="toast" id="toast"></div>

<div class="wrap grid">
  <section class="card">
    <div class="row">
      <div style="flex:1;min-width:220px">
        <label>–û“õ—É—à—ã–Ω—ã“£ –∞—Ç—ã-–∂”©–Ω—ñ</label>
        <input id="studentName" placeholder="–ú—ã—Å–∞–ª—ã: –ê–π–∞—Ä—É" />
      </div>
      <div style="width:140px">
        <label>–°—ã–Ω—ã–ø</label>
        <input id="studentClass" placeholder="10A" />
      </div>
      <div style="width:220px">
        <label>–ú–∏—Å—Å–∏—è (–µ—Å–µ–ø)</label>
        <select id="missionSelect"></select>
      </div>
    </div>

    <div class="sep"></div>

    <canvas id="view" aria-label="3D view"></canvas>

    <div class="sep"></div>

    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div style="flex:1;min-width:260px">
        <label>–ù—ã—Å–∞–Ω (—Ñ–∏–≥—É—Ä–∞)</label>
        <select id="sceneSelect"></select>
      </div>
      <div class="row">
        <button class="btn" id="resetViewBtn">‚Ü∫ –ö”©—Ä—ñ–Ω—ñ—Å—Ç—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É</button>
        <button class="btn warn" id="clearSelectionBtn">‚ú≥ –¢–∞“£–¥–∞—É–¥—ã —Ç–∞–∑–∞—Ä—Ç—É</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="row">
      <div style="flex:1;min-width:220px">
        <label>”®–ª—à–µ—É —Ä–µ–∂–∏–º—ñ</label>
        <select id="measureMode">
          <option value="angleLines">‚à† –¢“Ø–∑—É‚Äì—Ç“Ø–∑—É –±“±—Ä—ã—à—ã (2 –≤–µ–∫—Ç–æ—Ä)</option>
          <option value="angleLinePlane">‚à† –¢“Ø–∑—É‚Äì–∂–∞–∑—ã“õ—Ç—ã“õ –±“±—Ä—ã—à—ã (–≤–µ–∫—Ç–æ—Ä + –∂–∞–∑—ã“õ—Ç—ã“õ)</option>
          <option value="distSkew">d –ê–π“õ–∞—Å —Ç“Ø–∑—É–ª–µ—Ä –∞—Ä–∞“õ–∞—à—ã“õ—Ç—ã“ì—ã (2 —Ç“Ø–∑—É)</option>
        </select>
      </div>
      <div style="flex:1;min-width:260px">
        <label>–ñ–∞—É–∞–ø (”©–∑ —à–µ—à—ñ–º—ñ“£)</label>
        <input id="answerInput" placeholder="–ú—ã—Å–∞–ª—ã: cos=1/3 –Ω–µ–º–µ—Å–µ tan=... –Ω–µ–º–µ—Å–µ d=..." />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn ok" id="computeBtn">üìè –ï—Å–µ–ø—Ç–µ—É/”©–ª—à–µ—É</button>
      <button class="btn" id="hint1Btn">üí° –ö”©–º–µ–∫ 1</button>
      <button class="btn" id="hint2Btn">üí° –ö”©–º–µ–∫ 2</button>
      <button class="btn bad" id="revealBtn">üëÅ –ë–∞“ì—ã—Ç/–∏–¥–µ—è</button>
      <button class="btn" id="finishBtn">üìä –°–æ“£“ì—ã —Ç–∞–ª–¥–∞—É</button>
    </div>

    <div class="sep"></div>

    <details id="hintBox1" style="display:none">
      <summary>–ö”©–º–µ–∫ 1</summary>
      <div class="small" id="hint1Text"></div>
    </details>
    <details id="hintBox2" style="display:none;margin-top:10px">
      <summary>–ö”©–º–µ–∫ 2</summary>
      <div class="small" id="hint2Text"></div>
    </details>
    <details id="revealBox" style="display:none;margin-top:10px">
      <summary>–ë–∞“ì—ã—Ç/–∏–¥–µ—è (—Ç–æ–ª—ã“õ –µ–º–µ—Å)</summary>
      <div class="small mono" id="revealText" style="white-space:pre-wrap"></div>
    </details>

    <div class="sep"></div>

    <div class="hint">
      <b>“ö–∞–ª–∞–π –æ–π–Ω–∞–π—Å—ã“£:</b>
      <div class="small" style="margin-top:6px">
        1) –§–∏–≥—É—Ä–∞–Ω—ã mouse/touch-–ø–µ–Ω —Å“Ø–π—Ä–µ–ø –∞–π–Ω–∞–ª–¥—ã—Ä.<br>
        2) –ù“Ø–∫—Ç–µ–ª–µ—Ä–¥—ñ –±–∞—Å—ã–ø —Ç–∞“£–¥–∞ (–∂–∞—Å—ã–ª –±–æ–ª—ã–ø –∂–∞–Ω–∞–¥—ã).<br>
        3) ”®–ª—à–µ—É —Ä–µ–∂–∏–º—ñ–Ω —Ç–∞“£–¥–∞ –¥–∞ <span class="mono">–ï—Å–µ–ø—Ç–µ—É/”©–ª—à–µ—É</span> –±–∞—Å.<br>
        4) ”ò—Ä –º–∏—Å—Å–∏—è–¥–∞ —Å–µ–Ω—ñ“£: ”ô—Ä–µ–∫–µ—Ç, “õ–∞—Ç–µ, –∫”©–º–µ–∫, —É–∞“õ—ã—Ç –µ—Å–µ–ø—Ç–µ–ª–µ–¥—ñ.
      </div>
    </div>

    <div class="sep"></div>
    <div class="small" id="taskMeta"></div>
  </section>

  <aside class="card">
    <b>–ù”ô—Ç–∏–∂–µ –ø–∞–Ω–µ–ª—ñ</b>
    <div class="sep"></div>

    <div class="kpi">
      <div class="box"><div class="n" id="kpiDone">0</div><div class="t">–ê—è“õ—Ç–∞–ª“ì–∞–Ω –º–∏—Å—Å–∏—è</div></div>
      <div class="box"><div class="n" id="kpiWrong">0</div><div class="t">“ö–∞—Ç–µ ”ô—Ä–µ–∫–µ—Ç</div></div>
      <div class="box"><div class="n" id="kpiHints">0</div><div class="t">–ö”©–º–µ–∫ —Å–∞–Ω—ã</div></div>
      <div class="box"><div class="n" id="kpiTime">00:00</div><div class="t">–ñ–∞–ª–ø—ã —É–∞“õ—ã—Ç</div></div>
    </div>

    <div class="sep"></div>

    <b>”®–ª—à–µ—É –Ω”ô—Ç–∏–∂–µ—Å—ñ</b>
    <div class="small mono" id="measureOut" style="white-space:pre-wrap;margin-top:8px">
–¢–∞“£–¥–∞—É –∂–∞—Å–∞ –¥–∞ –µ—Å–µ–ø—Ç–µ.
    </div>

    <div class="sep"></div>

    <b>–ú–∏—Å—Å–∏—è –º”ô—Ç—ñ–Ω—ñ</b>
    <div class="small mono" id="missionText" style="white-space:pre-wrap;margin-top:8px"></div>

    <div class="sep"></div>

    <b>–ï—Å–µ–ø –±–µ—Ä—É</b>
    <div class="row">
      <button class="btn" id="copyReportBtn">üßæ –ö”©—à—ñ—Ä—É</button>
      <button class="btn" id="clearAllBtn">üóë –¢–∞–∑–∞—Ä—Ç—É</button>
    </div>
  </aside>
</div>

<script>
/* =========================
   0) –ú–∏—Å—Å–∏—è–ª–∞—Ä (12 –µ—Å–µ–ø) ‚Äî —Å—Ç–∏–ª—å/–º”ô—Ç—ñ–Ω
   ========================= */
const MISSIONS = [
  {
    id: 1,
    title: "1) “Æ—à–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞: ‚à†(AB, A‚ÇÅC)",
    scene: "triPrism",
    text:
`ABC A‚ÇÅB‚ÇÅC‚ÇÅ –¥“±—Ä—ã—Å “Ø—à–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞–Ω—ã“£ –±–∞—Ä–ª—ã“õ “õ—ã—Ä–ª–∞—Ä—ã 1-–≥–µ —Ç–µ“£.
AB –∂”ô–Ω–µ A‚ÇÅC —Ç“Ø–∑—É–ª–µ—Ä—ñ–Ω—ñ“£ –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à—Ç—ã“£ cos –º”ô–Ω—ñ–Ω —Ç–∞–ø.`,
    hint1: "–ï–∫—ñ —Ç“Ø–∑—É –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à: –±–∞“ì—ã—Ç—Ç–∞—É—à—ã –≤–µ–∫—Ç–æ—Ä–ª–∞—Ä –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à.",
    hint2: "AB –≤–µ–∫—Ç–æ—Ä—ã –º–µ–Ω A‚ÇÅC –≤–µ–∫—Ç–æ—Ä—ã–Ω –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–ª—ã“õ –º–æ–¥–µ–ª—å–≥–µ –∫–µ–ª—Ç—ñ—Ä—ñ–ø, —Å–∫–∞–ª—è—Ä –∫”©–±–µ–π—Ç—ñ–Ω–¥—ñ–Ω—ñ “õ–æ–ª–¥–∞–Ω.",
    reveal: "–û–π: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ “õ–æ–π (A(0,0,0), B(1,0,0) ...), A‚ÇÅ ‚Äî –±–∏—ñ–∫—Ç—ñ–∫ –±–æ–π—ã–Ω—à–∞. –°–æ—Å—ã–Ω cos = (u¬∑v)/(|u||v|)."
  },
  {
    id: 2,
    title: "2) –¶–∏–ª–∏–Ω–¥—Ä: –∂–∞–∑—ã“õ—Ç—ã“õ—Ç–∞—Ä –±“±—Ä—ã—à—ã (tan)",
    scene: "cylSketch",
    text:
`–¶–∏–ª–∏–Ω–¥—Ä —Ç–∞–±–∞–Ω—ã–Ω—ã“£ –¥–∏–∞–º–µ—Ç—Ä—ñ 20, –∂–∞—Å–∞—É—à—ã—Å—ã 28.
–ñ–∞–∑—ã“õ—Ç—ã“õ —Ü–∏–ª–∏–Ω–¥—Ä–¥—ñ: —Ç–∞–±–∞–Ω—ã–Ω–¥–∞ “±–∑—ã–Ω–¥—ã“ì—ã 12, –∂–∞—Å–∞—É—à—ã—Å—ã–Ω–¥–∞ 16 —Ö–æ—Ä–¥–∞ –±–æ–π—ã–Ω—à–∞ “õ–∏—ã–ø ”©—Ç–µ–¥—ñ.
–¶–∏–ª–∏–Ω–¥—Ä —Ç–∞–±–∞–Ω—ã –∂–∞–∑—ã“õ—Ç—ã“ì—ã –º–µ–Ω –æ—Å—ã –∂–∞–∑—ã“õ—Ç—ã“õ –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à—Ç—ã“£ —Ç–∞–Ω–≥–µ–Ω—Å—ñ–Ω —Ç–∞–ø.`,
    hint1: "–ë“±–ª ‚Äî ‚Äú“õ–∏—ã–ø ”©—Ç–µ—Ç—ñ–Ω –∂–∞–∑—ã“õ—Ç—ã“õ‚Äù –±“±—Ä—ã—à—ã: —Ç—ñ–∫ “õ–∏–º–∞–¥–∞ —Ç—ñ–∫–±“±—Ä—ã—à—Ç—ã “Ø—à–±“±—Ä—ã—à –ø–∞–π–¥–∞ –±–æ–ª–∞–¥—ã.",
    hint2: "–¢–∞–±–∞–Ω–¥–∞“ì—ã —Ö–æ—Ä–¥–∞ –º–µ–Ω –∂–∞—Å–∞—É—à—ã–¥–∞“ì—ã –∫–µ—Å—ñ–Ω–¥—ñ–≥–µ —Å”ô–π–∫–µ—Å –±–∏—ñ–∫—Ç—ñ–∫/–ø—Ä–æ–µ–∫—Ü–∏—è–ª–∞—Ä–¥—ã —Å–∞–ª—ã—Å—Ç—ã—Ä.",
    reveal: "–ë“±–ª –º–∏—Å—Å–∏—è–¥–∞ 3D –µ–º–µ—Å, —Å—Ö–µ–º–∞–ª—ã“õ –æ–π–ª–∞—É: –ø—Ä–æ–µ–∫—Ü–∏—è, —Ç—ñ–∫ “õ–∏–º–∞, tan = “õ–∞—Ä—Å—ã –∫–∞—Ç–µ—Ç / –∂–∞–Ω–∞–º–∞ –∫–∞—Ç–µ—Ç."
  },
  {
    id: 3,
    title: "3) –¢—ñ–∫ —Ç”©—Ä—Ç–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞: –∞–π“õ–∞—Å —Ç“Ø–∑—É–ª–µ—Ä –∞—Ä–∞“õ–∞—à—ã“õ—Ç—ã“ì—ã",
    scene: "rectPrism",
    text:
`ABCDA‚ÇÅB‚ÇÅC‚ÇÅD‚ÇÅ —Ç”©—Ä—Ç–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞—Å—ã–Ω—ã“£ —Ç–∞–±–∞–Ω—ã ‚Äî —Ç—ñ–∫—Ç”©—Ä—Ç–±“±—Ä—ã—à.
AB=12, AD=‚àö31. AC –∂”ô–Ω–µ B‚ÇÅD‚ÇÅ —Ç“Ø–∑—É–ª–µ—Ä—ñ–Ω—ñ“£ –∞—Ä–∞“õ–∞—à—ã“õ—Ç—ã“ì—ã 5.
AD “õ–∞–±—ã—Ä“ì–∞—Å—ã–Ω—ã“£ –æ—Ä—Ç–∞—Å—ã –∞—Ä“õ—ã–ª—ã B‚ÇÅD‚ÇÅ-“ì–∞ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä –∂“Ø—Ä–≥—ñ–∑—ñ–ª–≥–µ–Ω –∂–∞–∑—ã“õ—Ç—ã“õ –ø–µ–Ω –ø—Ä–∏–∑–º–∞ —Ç–∞–±–∞–Ω—ã –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à—Ç—ã“£ cos –º”ô–Ω—ñ–Ω —Ç–∞–ø.`,
    hint1: "–ê–π“õ–∞—Å —Ç“Ø–∑—É–ª–µ—Ä –∞—Ä–∞“õ–∞—à—ã“õ—Ç—ã“ì—ã: d = |(w¬∑(u√óv))|/|u√óv|.",
    hint2: "–ñ–∞–∑—ã“õ—Ç—ã“õ—Ç–∞—Ä –±“±—Ä—ã—à—ã: –Ω–æ—Ä–º–∞–ª—å –≤–µ–∫—Ç–æ—Ä–ª–∞—Ä –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à.",
    reveal: "–û–π: 3D –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ “õ–æ–π—ã–ø, u=AC, v=B‚ÇÅD‚ÇÅ, w=AB‚ÇÅ —Å–∏—è“õ—Ç—ã –≤–µ–∫—Ç–æ—Ä–ª–∞—Ä–º–µ–Ω d —à–∞—Ä—Ç—ã–Ω “õ–æ–ª–¥–∞–Ω."
  },
  {
    id: 4,
    title: "4) –ö—É–±: ‚à†(AA‚ÇÅ, BC‚ÇÅD) —Ç–∞–Ω–≥–µ–Ω—Å—ñ",
    scene: "cube",
    text:
`ABCDA‚ÇÅB‚ÇÅC‚ÇÅD‚ÇÅ –∫—É–±—ã–Ω–¥–∞ AA‚ÇÅ —Ç“Ø–∑—É—ñ –º–µ–Ω BC‚ÇÅD –∂–∞–∑—ã“õ—Ç—ã“ì—ã –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à—Ç—ã“£ tan –º”ô–Ω—ñ–Ω —Ç–∞–ø.`,
    hint1: "–¢“Ø–∑—É‚Äì–∂–∞–∑—ã“õ—Ç—ã“õ –±“±—Ä—ã—à—ã = 90¬∞ ‚àí (—Ç“Ø–∑—É –±–∞“ì—ã—Ç—ã –º–µ–Ω –∂–∞–∑—ã“õ—Ç—ã“õ –Ω–æ—Ä–º–∞–ª—ã –±“±—Ä—ã—à—ã).",
    hint2: "–ñ–∞–∑—ã“õ—Ç—ã“õ –Ω–æ—Ä–º–∞–ª—ã–Ω –µ–∫—ñ –±–∞“ì—ã—Ç—Ç–∞—É—à—ã –≤–µ–∫—Ç–æ—Ä–¥—ã“£ –≤–µ–∫—Ç–æ—Ä–ª—ã“õ –∫”©–±–µ–π—Ç—ñ–Ω–¥—ñ—Å—ñ–º–µ–Ω —Ç–∞–ø.",
    reveal: "–û–π: –∫—É–±—Ç—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–µ–Ω –±–µ–ª–≥—ñ–ª–µ (A(0,0,0), ...). AA‚ÇÅ –±–∞“ì—ã—Ç—ã (0,0,1). –ñ–∞–∑—ã“õ—Ç—ã“õ—Ç—ã“£ –Ω–æ—Ä–º–∞–ª—ã–Ω —Ç–∞–ø ‚Üí –±“±—Ä—ã—à."
  },
  {
    id: 5,
    title: "5) –ö—É–±: ‚à†(AC‚ÇÅ, BCC‚ÇÅ) —Ç–∞–Ω–≥–µ–Ω—Å—ñ",
    scene: "cube",
    text:
`ABCDA‚ÇÅB‚ÇÅC‚ÇÅD‚ÇÅ –∫—É–±—ã–Ω–¥–∞ AC‚ÇÅ —Ç“Ø–∑—É—ñ –º–µ–Ω BCC‚ÇÅ –∂–∞–∑—ã“õ—Ç—ã“ì—ã –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à—Ç—ã“£ tan –º”ô–Ω—ñ–Ω —Ç–∞–ø.`,
    hint1: "BCC‚ÇÅ –∂–∞–∑—ã“õ—Ç—ã“ì—ã ‚Äî –∫—É–±—Ç—ã“£ –±—ñ—Ä “õ–∞–±—ã—Ä“ì–∞—Å—ã (x=1 —Å–∏—è“õ—Ç—ã).",
    hint2: "–¢“Ø–∑—É –±–∞“ì—ã—Ç—ã: AC‚ÇÅ –≤–µ–∫—Ç–æ—Ä—ã. –ñ–∞–∑—ã“õ—Ç—ã“õ –Ω–æ—Ä–º–∞–ª—ã –±–µ–ª–≥—ñ–ª—ñ (–º—ã—Å–∞–ª—ã (1,0,0)).",
    reveal: "–û–π: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–¥–∞ BCC‚ÇÅ –∂–∞–∑—ã“õ—Ç—ã“ì—ã –Ω–æ—Ä–º–∞–ª—ã –æ“£–∞–π. –ë“±—Ä—ã—à—Ç—ã –Ω–æ—Ä–º–∞–ª—å –∞—Ä“õ—ã–ª—ã —Ç–∞–ø."
  },
  {
    id: 6,
    title: "6) –î“±—Ä—ã—Å —Ç”©—Ä—Ç–±“±—Ä—ã—à—Ç—ã –ø–∏—Ä–∞–º–∏–¥–∞: cos ‚à†(AB, SAD)",
    scene: "sqPyramid",
    text:
`SABCD –¥“±—Ä—ã—Å —Ç”©—Ä—Ç–±“±—Ä—ã—à—Ç—ã –ø–∏—Ä–∞–º–∏–¥–∞—Å—ã–Ω—ã“£ –±–∞—Ä–ª—ã“õ “õ—ã—Ä–ª–∞—Ä—ã 1-–≥–µ —Ç–µ“£.
AB —Ç“Ø–∑—É—ñ –º–µ–Ω SAD –∂–∞–∑—ã“õ—Ç—ã“ì—ã –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à—Ç—ã“£ cos –º”ô–Ω—ñ–Ω —Ç–∞–ø.`,
    hint1: "–¢“Ø–∑—É‚Äì–∂–∞–∑—ã“õ—Ç—ã“õ: AB –±–∞“ì—ã—Ç—ã –∂”ô–Ω–µ SAD –∂–∞–∑—ã“õ—Ç—ã“ì—ã –Ω–æ—Ä–º–∞–ª—ã –∫–µ—Ä–µ–∫.",
    hint2: "SAD –∂–∞–∑—ã“õ—Ç—ã“ì—ã–Ω S,A,D –∞—Ä“õ—ã–ª—ã –±–µ—Ä—ñ–ø, –Ω–æ—Ä–º–∞–ª—å–¥—ñ (SA√óSD) –∞—Ä“õ—ã–ª—ã –∞–ª.",
    reveal: "–û–π: —Ç–∞–±–∞–Ω–¥—ã xy –∂–∞–∑—ã“õ—Ç—ã“ì—ã–Ω–∞ “õ–æ–π, S —Ç”©–±–µ—Å—ñ–Ω –æ—Ä—Ç–∞–Ω—ã“£ “Ø—Å—Ç—ñ–Ω–µ –∫”©—Ç–µ—Ä."
  },
  {
    id: 7,
    title: "7) –î“±—Ä—ã—Å –∞–ª—Ç—ã–±“±—Ä—ã—à—Ç—ã –ø–∏—Ä–∞–º–∏–¥–∞: cos ‚à†(AC, SAF)",
    scene: "hexPyramid",
    text:
`SABCDEF –¥“±—Ä—ã—Å –∞–ª—Ç—ã–±“±—Ä—ã—à—Ç—ã –ø–∏—Ä–∞–º–∏–¥–∞—Å—ã–Ω–¥–∞ –±“Ø–π—ñ—Ä “õ—ã—Ä–ª–∞—Ä—ã 2, —Ç–∞–±–∞–Ω “õ–∞–±—ã—Ä“ì–∞—Å—ã 1.
AC —Ç“Ø–∑—É—ñ –º–µ–Ω SAF –∂–∞–∑—ã“õ—Ç—ã“ì—ã –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à—Ç—ã“£ cos –º”ô–Ω—ñ–Ω —Ç–∞–ø.`,
    hint1: "–ê–ª—Ç—ã–±“±—Ä—ã—à—Ç—ã“£ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Å—ã–Ω —à–µ“£–±–µ—Ä –±–æ–π—ã–Ω–∞ “õ–æ–π—Å–∞“£ —ã“£“ì–∞–π–ª—ã.",
    hint2: "SAF –∂–∞–∑—ã“õ—Ç—ã“ì—ã –Ω–æ—Ä–º–∞–ª—ã: (SA√óSF). AC –±–∞“ì—ã—Ç—ã: C‚àíA.",
    reveal: "–û–π: –¥“±—Ä—ã—Å –∞–ª—Ç—ã–±“±—Ä—ã—à—Ç–∞ —Ä–∞–¥–∏—É—Å=“õ–∞–±—ã—Ä“ì–∞. S –±–∏—ñ–∫—Ç—ñ–≥—ñ –±“Ø–π—ñ—Ä “õ—ã—Ä –∞—Ä“õ—ã–ª—ã —Ç–∞–±—ã–ª–∞–¥—ã."
  },
  {
    id: 8,
    title: "8) –î“±—Ä—ã—Å —Ç”©—Ä—Ç–±“±—Ä—ã—à—Ç—ã –ø–∏—Ä–∞–º–∏–¥–∞: cos ‚à†(ABC, SBC)",
    scene: "sqPyramid",
    text:
`SABCD –¥“±—Ä—ã—Å —Ç”©—Ä—Ç–±“±—Ä—ã—à—Ç—ã –ø–∏—Ä–∞–º–∏–¥–∞—Å—ã–Ω–¥–∞ –±–∞—Ä–ª—ã“õ “õ—ã—Ä–ª–∞—Ä—ã 1.
ABC –∂–∞–∑—ã“õ—Ç—ã“ì—ã –º–µ–Ω SBC –∂–∞–∑—ã“õ—Ç—ã“ì—ã –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à—Ç—ã“£ cos –º”ô–Ω—ñ–Ω —Ç–∞–ø.`,
    hint1: "–ï–∫—ñ –∂–∞–∑—ã“õ—Ç—ã“õ –±“±—Ä—ã—à—ã: –Ω–æ—Ä–º–∞–ª—å–¥–∞—Ä –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à.",
    hint2: "n1 = (AB√óAC), n2 = (SB√óSC) –Ω–µ–º–µ—Å–µ (SB√óBC).",
    reveal: "–û–π: —Ç–∞–±–∞–Ω –Ω–æ—Ä–º–∞–ª—ã –æ“£–∞–π, –±“Ø–π—ñ—Ä –±–µ—Ç –Ω–æ—Ä–º–∞–ª—ã–Ω –≤–µ–∫—Ç–æ—Ä–ª—ã“õ –∫”©–±–µ–π—Ç—ñ–Ω–¥—ñ–º–µ–Ω —Ç–∞–ø."
  },
  {
    id: 9,
    title: "9) –î“±—Ä—ã—Å –∞–ª—Ç—ã–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞: ‚à†(AB‚ÇÅ, BE‚ÇÅ) —Ç–∞–±—É",
    scene: "hexPrism",
    text:
`ABCDEF A‚ÇÅB‚ÇÅC‚ÇÅD‚ÇÅE‚ÇÅF‚ÇÅ –¥“±—Ä—ã—Å –∞–ª—Ç—ã–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞–Ω—ã“£ –±–∞—Ä–ª—ã“õ “õ—ã—Ä–ª–∞—Ä—ã 1.
AB‚ÇÅ –∂”ô–Ω–µ BE‚ÇÅ —Ç“Ø–∑—É–ª–µ—Ä—ñ–Ω—ñ“£ –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à—Ç—ã —Ç–∞–ø.`,
    hint1: "–ï–∫—ñ —Ç“Ø–∑—É –±“±—Ä—ã—à—ã ‚Äî –æ–ª–∞—Ä–¥—ã“£ –±–∞“ì—ã—Ç—Ç–∞—É—à—ã –≤–µ–∫—Ç–æ—Ä–ª–∞—Ä—ã –±“±—Ä—ã—à—ã.",
    hint2: "AB‚ÇÅ = B‚ÇÅ‚àíA, BE‚ÇÅ = E‚ÇÅ‚àíB. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–¥–∞ –µ—Å–µ–ø—Ç–µ.",
    reveal: "–û–π: –∞–ª—Ç—ã–±“±—Ä—ã—à—Ç—ã xy –∂–∞–∑—ã“õ—Ç—ã“ì—ã–Ω–∞, –±–∏—ñ–∫—Ç—ñ–∫—Ç—ñ z-–∫–µ “õ–æ–π."
  },
  {
    id: 10,
    title: "10) –ü–∏—Ä–∞–º–∏–¥–∞: ‚à†(AD, BC) —Ç–∞–±—É (“õ–æ—Å—ã–º—à–∞ —à–∞—Ä—Ç)",
    scene: "rectPyrSketch",
    text:
`ABCD –ø–∏—Ä–∞–º–∏–¥–∞—Å—ã–Ω–¥–∞ AD=24, BC=10.
BD –∂”ô–Ω–µ AC “õ–∞–±—ã—Ä“ì–∞–ª–∞—Ä—ã–Ω—ã“£ –æ—Ä—Ç–∞–ª–∞—Ä—ã–Ω—ã“£ –∞—Ä–∞“õ–∞—à—ã“õ—Ç—ã“ì—ã 13.
AD –∂”ô–Ω–µ BC —Ç“Ø–∑—É–ª–µ—Ä—ñ–Ω—ñ“£ –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –±“±—Ä—ã—à—Ç—ã —Ç–∞–ø.`,
    hint1: "–ï–∫—ñ —Ç“Ø–∑—É–¥—ñ“£ –±“±—Ä—ã—à—ã “Ø—à—ñ–Ω –±–∞“ì—ã—Ç—Ç–∞—É—à—ã –≤–µ–∫—Ç–æ—Ä–ª–∞—Ä –∂–µ—Ç–∫—ñ–ª—ñ–∫—Ç—ñ.",
    hint2: "–û—Ä—Ç–∞ –Ω“Ø–∫—Ç–µ–ª–µ—Ä –∞—Ä–∞—Å—ã ‚Äî –≤–µ–∫—Ç–æ—Ä–ª—ã“õ –±–∞–π–ª–∞–Ω—ã—Å –±–µ—Ä–µ–¥—ñ (–ø–∞—Ä–∞–ª–ª–µ–ª–æ–≥—Ä–∞–º–º –∏–¥–µ—è—Å—ã).",
    reveal: "–ë“±–ª –º–∏—Å—Å–∏—è ‚Äî –∫–µ“£—ñ—Å—Ç—ñ–∫ –≤–µ–∫—Ç–æ—Ä–ª—ã“õ “õ–∞—Ç—ã–Ω–∞—Å“õ–∞ “õ“±—Ä—ã–ª“ì–∞–Ω: –æ—Ä—Ç–∞ –Ω“Ø–∫—Ç–µ –≤–µ–∫—Ç–æ—Ä–ª–∞—Ä—ã –∞—Ä“õ—ã–ª—ã AD,BC –∞—Ä–∞—Å—ã–Ω —à—ã“ì–∞—Ä."
  },
  {
    id: 11,
    title: "11) –®–∞—Ä: –∫–µ—Å—É –º—ñ–Ω–¥–µ—Ç—Ç—ñ –º–µ?",
    scene: "sphereSketch",
    text:
`–î–∏–∞–º–µ—Ç—Ä—ñ 20 —Å–º —à–∞—Ä (“õ–∞—Ä–±—ã–∑). ”®–∑–∞—Ä–∞ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä –µ–∫—ñ –∂–∞–∑—ã“õ –∫–µ—Å—É –∂–∞—Å–∞–ª–∞–¥—ã.
h ‚Äî —Å–µ–≥–º–µ–Ω—Ç –±–∏—ñ–∫—Ç—ñ–≥—ñ.
a) h=17 —Å–º –±–æ–ª—Å–∞, –º—ñ–Ω–¥–µ—Ç—Ç—ñ —Ç“Ø—Ä–¥–µ –∫–µ–º—ñ–Ω–¥–µ 2 –±”©–ª—ñ–∫–∫–µ –±”©–ª—ñ–Ω–µ–¥—ñ –º–µ?
b) h=18 —Å–º –±–æ–ª—Å–∞ —à–µ?`,
    hint1: "–®–∞—Ä —Å–µ–≥–º–µ–Ω—Ç—ñ –≥–µ–æ–º–µ—Ç—Ä–∏—è—Å—ã: —Ä–∞–¥–∏—É—Å, h, “õ–∏–º–∞ —à–µ“£–±–µ—Ä —Ä–∞–¥–∏—É—Å—ã –±–∞–π–ª–∞–Ω—ã—Å–∞–¥—ã.",
    hint2: "–ï–∫—ñ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä –∂–∞–∑—ã“õ—Ç—ã“õ—Ç—ã“£ “õ–∏–º–∞–ª–∞—Ä—ã —à–∞—Ä —ñ—à—ñ–Ω–¥–µ “õ–∞–ª–∞–π “õ–∏—ã–ª—ã—Å–∞—Ç—ã–Ω—ã–Ω –æ–π–ª–∞.",
    reveal: "–ë“±–ª ‚Äî –¥”ô–ª 3D –µ—Å–µ–ø –µ–º–µ—Å, –ª–æ–≥–∏–∫–∞–ª—ã“õ-–≥–µ–æ–º–µ—Ç—Ä–∏—è–ª—ã“õ —Ç–∞–ª–¥–∞—É: “õ–∏–º–∞ —à–µ“£–±–µ—Ä–ª–µ—Ä—ñ–Ω—ñ“£ “õ–∏—ã–ª—ã—Å—É—ã/“õ–∏—ã–ª—ã—Å–ø–∞—É—ã."
  },
  {
    id: 12,
    title: "12) –ü—Ä–∏–∑–º–∞: –µ–∫—ñ “õ–∏—é–¥–∞–Ω —à—ã“õ“õ–∞–Ω “Ø—à–±“±—Ä—ã—à—Ç–∞—Ä (–º“Ø–º–∫—ñ–Ω –±–µ?)",
    scene: "prismSketch",
    text:
`“Æ—à–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞ —Ç”ô—Ä—ñ–∑–¥–µ—Å –¥–µ–Ω–µ–¥–µ–Ω –µ–∫—ñ –∂–∞“ì—ã–Ω–∞–Ω –¥–∞ ‚Äú–∂–∞–∑—ã“õ‚Äù “õ–∏—é –∂–∞—Å–∞–ª–¥—ã.
–ö–µ—Å—ñ–ª–≥–µ–Ω –±”©–ª—ñ–∫—Ç–µ—Ä —Ç–∞–±–∞–Ω—ã–Ω–∞ –¥–∞, –±—ñ—Ä-–±—ñ—Ä—ñ–Ω–µ –¥–µ —Ç–∏–º–µ–π–¥—ñ.
a) –ö–µ—Å—ñ–ª–≥–µ–Ω –±”©–ª—ñ–∫—Ç–µ—Ä “±“õ—Å–∞—Å, –±—ñ—Ä–∞“õ —Ç–µ“£ –µ–º–µ—Å “Ø—à–±“±—Ä—ã—à –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω –±–µ?
b) –ë—ñ—Ä—ñ “õ–∞–±—ã—Ä“ì–∞—Å—ã 1 —Ç–µ“£ “õ–∞–±—ã—Ä“ì–∞–ª—ã, –µ–∫—ñ–Ω—à—ñ—Å—ñ “õ–∞–±—ã—Ä“ì–∞—Å—ã 2 —Ç–µ“£ “õ–∞–±—ã—Ä“ì–∞–ª—ã –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω –±–µ?`,
    hint1: "“ö–∏—é –∂–∞–∑—ã“õ—Ç—ã“õ—Ç–∞—Ä—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å/–ø–∞—Ä–∞–ª–ª–µ–ª—å –µ–º–µ—Å –∂–∞“ì–¥–∞–π—ã–Ω “õ–∞—Ä–∞—Å—Ç—ã—Ä.",
    hint2: "“∞“õ—Å–∞—Å—Ç—ã“õ –ø–µ–Ω –º–∞—Å—à—Ç–∞–± ‚Äî “õ–∏–º–∞–ª–∞—Ä–¥—ã“£ –∞—Ä–∞“õ–∞—à—ã“õ—Ç—ã“ì—ã–Ω–∞ —Ç”ô—É–µ–ª–¥—ñ.",
    reveal: "–ë“±–ª –º–∏—Å—Å–∏—è ‚Äî —Ç–µ–æ—Ä–∏—è–ª—ã“õ –¥”ô–ª–µ–ª/“õ–∞—Ä—Å—ã –º—ã—Å–∞–ª —Å—Ç–∏–ª—ñ: ‚Äú–±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω/–º“Ø–º–∫—ñ–Ω –µ–º–µ—Å‚Äù –ª–æ–≥–∏–∫–∞—Å—ã."
  },
];

/* =========================
   1) 3D –ú–∏–Ω–∏-–¥–≤–∏–∂–æ–∫ (–≤–Ω–µ—à. –∫—ñ—Ç–∞–ø—Ö–∞–Ω–∞ –∂–æ“õ)
   ========================= */
const canvas = document.getElementById("view");
const ctx = canvas.getContext("2d");

function fitCanvas(){
  const r = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(r.width * dpr);
  canvas.height = Math.floor(r.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener("resize", fitCanvas);
fitCanvas();

const V = (x,y,z)=>({x,y,z});
const add=(a,b)=>V(a.x+b.x,a.y+b.y,a.z+b.z);
const sub=(a,b)=>V(a.x-b.x,a.y-b.y,a.z-b.z);
const mul=(a,k)=>V(a.x*k,a.y*k,a.z*k);
const dot=(a,b)=>a.x*b.x+a.y*b.y+a.z*b.z;
const cross=(a,b)=>V(a.y*b.z-a.z*b.y, a.z*b.x-a.x*b.z, a.x*b.y-a.y*b.x);
const norm=(a)=>Math.sqrt(dot(a,a));
const unit=(a)=>{const n=norm(a)||1; return V(a.x/n,a.y/n,a.z/n);};

function rotY(p, ang){
  const c=Math.cos(ang), s=Math.sin(ang);
  return V(p.x*c + p.z*s, p.y, -p.x*s + p.z*c);
}
function rotX(p, ang){
  const c=Math.cos(ang), s=Math.sin(ang);
  return V(p.x, p.y*c - p.z*s, p.y*s + p.z*c);
}
function project(p){
  // simple perspective
  const z = p.z + 4.0; // camera distance
  const f = 1.15 / z;
  return {x: p.x*f, y: p.y*f, z: p.z};
}

/* =========================
   2) –°—Ü–µ–Ω–∞–ª–∞—Ä: –Ω“Ø–∫—Ç–µ–ª–µ—Ä/“õ—ã—Ä–ª–∞—Ä/–∂–∞–∑—ã“õ—Ç—ã“õ—Ç–∞—Ä
   (–∫”©—Ä–Ω–µ–∫—ñ, ”©–ª—à–µ—É–≥–µ –∂–µ—Ç–∫—ñ–ª—ñ–∫—Ç—ñ –º–æ–¥–µ–ª—å)
   ========================= */
function buildCube(){
  // unit cube
  const pts = {
    A: V(0,0,0), B: V(1,0,0), C: V(1,1,0), D: V(0,1,0),
    A1: V(0,0,1), B1: V(1,0,1), C1: V(1,1,1), D1: V(0,1,1),
  };
  const edges = [
    ["A","B"],["B","C"],["C","D"],["D","A"],
    ["A1","B1"],["B1","C1"],["C1","D1"],["D1","A1"],
    ["A","A1"],["B","B1"],["C","C1"],["D","D1"],
    ["B","C1"],["D","C1"],["A","C1"], // diagonals for missions
  ];
  const planes = {
    // plane name -> 3 points defining it
    "BCC1": ["B","C","C1"],
    "BC1D": ["B","C1","D"],
    "SAD": null,
  };
  return {name:"–ö—É–±", pts, edges, planes};
}

function buildRectPrism(){
  const a=2.2, b=1.2, h=1.4;
  const pts = {
    A:V(0,0,0), B:V(a,0,0), C:V(a,b,0), D:V(0,b,0),
    A1:V(0,0,h), B1:V(a,0,h), C1:V(a,b,h), D1:V(0,b,h),
  };
  const edges = [
    ["A","B"],["B","C"],["C","D"],["D","A"],
    ["A1","B1"],["B1","C1"],["C1","D1"],["D1","A1"],
    ["A","A1"],["B","B1"],["C","C1"],["D","D1"],
    ["A","C"],["B1","D1"],["A","B1"],["D","B1"]
  ];
  const planes = {
    "Base": ["A","B","C"],
    "PerpToB1D1_throughMidAD": ["A","D","B1"], // just illustrative
  };
  return {name:"–¢—ñ–∫ —Ç”©—Ä—Ç–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞", pts, edges, planes};
}

function buildTriPrism(){
  // equilateral triangle base, height 1
  const A=V(0,0,0), B=V(1,0,0), C=V(0.5,Math.sqrt(3)/2,0);
  const h=1;
  const pts = {A,B,C, A1:add(A,V(0,0,h)), B1:add(B,V(0,0,h)), C1:add(C,V(0,0,h))};
  const edges = [
    ["A","B"],["B","C"],["C","A"],
    ["A1","B1"],["B1","C1"],["C1","A1"],
    ["A","A1"],["B","B1"],["C","C1"],
    ["A1","C"],["A","C1"]
  ];
  const planes = { "A1BC": ["A1","B","C"] };
  return {name:"“Æ—à–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞", pts, edges, planes};
}

function buildSqPyramid(){
  // square base side 1 centered at origin, apex above center
  const s=1;
  const A=V(-s/2,-s/2,0), B=V(s/2,-s/2,0), C=V(s/2,s/2,0), D=V(-s/2,s/2,0);
  // make all edges ~1 by choosing height
  // distance from center to vertex = s/‚àö2 = 0.707..., need apex so that SA=1 => h = sqrt(1 - (s/‚àö2)^2)
  const h=Math.sqrt(Math.max(0, 1 - (s*s/2)));
  const S=V(0,0,h);
  const pts={S,A,B,C,D};
  const edges=[["A","B"],["B","C"],["C","D"],["D","A"],["S","A"],["S","B"],["S","C"],["S","D"],["A","C"],["B","D"]];
  const planes={
    "SAD":["S","A","D"],
    "ABC":["A","B","C"],
    "SBC":["S","B","C"]
  };
  return {name:"–î“±—Ä—ã—Å —Ç”©—Ä—Ç–±“±—Ä—ã—à—Ç—ã –ø–∏—Ä–∞–º–∏–¥–∞", pts, edges, planes};
}

function buildHexPrism(){
  // regular hexagon radius 1, height 1
  const R=1, h=1;
  const names=["A","B","C","D","E","F"];
  const pts={};
  for(let i=0;i<6;i++){
    const ang = Math.PI/3*i;
    pts[names[i]] = V(R*Math.cos(ang), R*Math.sin(ang), 0);
    pts[names[i]+"1"] = V(R*Math.cos(ang), R*Math.sin(ang), h);
  }
  const edges=[];
  for(let i=0;i<6;i++){
    const n=names[i], n2=names[(i+1)%6];
    edges.push([n,n2],[n+"1",n2+"1"],[n,n+"1"]);
  }
  edges.push(["A","B1"],["B","E1"]); // for mission 9
  const planes={ "SAF": null };
  return {name:"–î“±—Ä—ã—Å –∞–ª—Ç—ã–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞", pts, edges, planes};
}

function buildHexPyramid(){
  // hex base radius 1, side 1, apex with lateral edge ~2
  const R=1;
  const names=["A","B","C","D","E","F"];
  const pts={};
  for(let i=0;i<6;i++){
    const ang=Math.PI/3*i;
    pts[names[i]]=V(R*Math.cos(ang), R*Math.sin(ang), 0);
  }
  // apex height so that SA=2 (A on radius 1): h = sqrt(4-1)=sqrt3
  pts["S"]=V(0,0,Math.sqrt(3));
  const edges=[];
  for(let i=0;i<6;i++){
    edges.push([names[i], names[(i+1)%6]]);
    edges.push(["S", names[i]]);
  }
  edges.push(["A","C"],["S","F"],["S","A"]);
  const planes={ "SAF":["S","A","F"] };
  return {name:"–î“±—Ä—ã—Å –∞–ª—Ç—ã–±“±—Ä—ã—à—Ç—ã –ø–∏—Ä–∞–º–∏–¥–∞", pts, edges, planes};
}

// sketches (2D-only scenes)
function buildSketch(name){
  return {name, pts:{}, edges:[], planes:{}};
}

const SCENES = {
  cube: buildCube,
  rectPrism: buildRectPrism,
  triPrism: buildTriPrism,
  sqPyramid: buildSqPyramid,
  hexPrism: buildHexPrism,
  hexPyramid: buildHexPyramid,
  cylSketch: ()=>buildSketch("–¶–∏–ª–∏–Ω–¥—Ä (—Å—Ö–µ–º–∞)"),
  sphereSketch: ()=>buildSketch("–®–∞—Ä (—Å—Ö–µ–º–∞)"),
  prismSketch: ()=>buildSketch("–ü—Ä–∏–∑–º–∞ (–ª–æ–≥–∏–∫–∞)"),
  rectPyrSketch: ()=>buildSketch("–ü–∏—Ä–∞–º–∏–¥–∞ (—Å—Ö–µ–º–∞)"),
};

let sceneKey = "cube";
let scene = SCENES[sceneKey]();

/* =========================
   3) –¢–∞“£–¥–∞—É –∂”ô–Ω–µ ”©–ª—à–µ—É
   ========================= */
let yaw = 0.6, pitch = -0.45;
let dragging=false, lastX=0, lastY=0;

const state = {
  missionIndex: 0,
  perMission: MISSIONS.map(()=>({
    startedAt:null, elapsed:0,
    attempts:0, wrong:0, done:0,
    usedHint1:false, usedHint2:false, revealed:false,
    modeCounts:{angleLines:0, angleLinePlane:0, distSkew:0},
    selectionOps:0,
  })),
};

let timer=null;

const selection = {
  points: [],  // selected point names
  plane: null, // selected plane name
};

function toast(msg){
  const el=document.getElementById("toast");
  el.textContent=msg;
  el.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>el.style.display="none", 2200);
}

function fmt(sec){
  const m=String(Math.floor(sec/60)).padStart(2,"0");
  const s=String(Math.floor(sec%60)).padStart(2,"0");
  return `${m}:${s}`;
}

function startTimer(){
  stopTimer();
  timer=setInterval(()=>{
    const m=state.perMission[state.missionIndex];
    if(!m.startedAt) m.startedAt=Date.now();
    m.elapsed=Math.floor((Date.now()-m.startedAt)/1000);
    renderMeta();
    renderKPIs();
  }, 250);
}
function stopTimer(){ if(timer) clearInterval(timer); timer=null; }

function normalizeAns(s){
  return (s||"").toLowerCase().replaceAll(" ","").replaceAll("‚àí","-");
}

/* =========================
   4) –†–µ–Ω–¥–µ—Ä
   ========================= */
function worldToScreen(p){
  let q=rotY(p, yaw);
  q=rotX(q, pitch);
  const pr=project(q);
  // scale and center
  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;
  const scale = Math.min(w,h) * 0.38;
  return {x: w/2 + pr.x*scale, y: h/2 - pr.y*scale, z: pr.z};
}

function draw(){
  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;
  ctx.clearRect(0,0,w,h);

  // background grid
  ctx.save();
  ctx.strokeStyle="rgba(99,102,241,.08)";
  ctx.lineWidth=1;
  for(let x=0;x<w;x+=28){
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
  }
  for(let y=0;y<h;y+=28){
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  }
  ctx.restore();

  if(Object.keys(scene.pts).length===0){
    // sketch mode
    ctx.save();
    ctx.fillStyle="rgba(23,32,72,.8)";
    ctx.font="600 16px system-ui";
    ctx.fillText(scene.name, 18, 28);
    ctx.fillStyle="rgba(90,102,143,.95)";
    ctx.font="13px system-ui";
    ctx.fillText("–ë“±–ª –º–∏—Å—Å–∏—è —Å—Ö–µ–º–∞–ª—ã“õ/–ª–æ–≥–∏–∫–∞–ª—ã“õ. 3D ”©–ª—à–µ—É –µ–º–µ—Å: –∫”©–º–µ–∫ –ø–µ–Ω –±–∞“ì—ã—Ç—Ç—ã “õ–æ–ª–¥–∞–Ω.", 18, 52);
    ctx.restore();
    requestAnimationFrame(draw);
    return;
  }

  // compute screen positions
  const sp={};
  for(const k in scene.pts) sp[k]=worldToScreen(scene.pts[k]);

  // edges sorted by depth (simple)
  const edges = scene.edges.map(e=>{
    const a=sp[e[0]], b=sp[e[1]];
    return {a:e[0],b:e[1], z:(a.z+b.z)/2};
  }).sort((x,y)=>x.z-y.z);

  // edges
  ctx.save();
  ctx.lineCap="round";
  edges.forEach(ed=>{
    const A=sp[ed.a], B=sp[ed.b];
    ctx.lineWidth=2;
    ctx.strokeStyle="rgba(23,32,72,.22)";
    // highlight if edge endpoints are selected for measurement
    const selA = selection.points.includes(ed.a);
    const selB = selection.points.includes(ed.b);
    if(selA && selB) ctx.strokeStyle="rgba(245,158,11,.80)";
    ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
  });
  ctx.restore();

  // points (clickable)
  const ptsSorted = Object.keys(sp).map(k=>({k, z:sp[k].z})).sort((a,b)=>a.z-b.z);
  ptsSorted.forEach(({k})=>{
    const p=sp[k];
    const selected = selection.points.includes(k);
    ctx.save();
    ctx.fillStyle = selected ? "rgba(16,185,129,.95)" : "rgba(99,102,241,.72)";
    ctx.strokeStyle = "rgba(23,32,72,.22)";
    ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.arc(p.x,p.y, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.fillStyle="rgba(23,32,72,.86)";
    ctx.font="12px system-ui";
    ctx.fillText(k, p.x+8, p.y-8);
    ctx.restore();
  });

  // overlay help
  ctx.save();
  ctx.fillStyle="rgba(23,32,72,.75)";
  ctx.font="12px system-ui";
  ctx.fillText("Drag: –∞–π–Ω–∞–ª–¥—ã—Ä—É ¬∑ –ù“Ø–∫—Ç–µ–Ω—ñ –±–∞—Å: —Ç–∞“£–¥–∞—É ¬∑ 4 –Ω“Ø–∫—Ç–µ = 2 —Ç“Ø–∑—É", 16, h-16);
  ctx.restore();

  requestAnimationFrame(draw);
}

/* =========================
   5) –¢–∞“£–¥–∞—É–¥—ã ”©“£–¥–µ—É (hit test)
   ========================= */
function hitPoint(x,y){
  if(Object.keys(scene.pts).length===0) return null;
  const sp={};
  for(const k in scene.pts) sp[k]=worldToScreen(scene.pts[k]);
  let best=null, bestD=1e9;
  for(const k in sp){
    const p=sp[k];
    const d=Math.hypot(p.x-x,p.y-y);
    if(d<14 && d<bestD){ best=k; bestD=d; }
  }
  return best;
}

canvas.addEventListener("pointerdown",(e)=>{
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left, y=e.clientY-r.top;
  const hp=hitPoint(x,y);
  if(hp){
    togglePoint(hp);
    return;
  }
  dragging=true;
  lastX=e.clientX; lastY=e.clientY;
  canvas.setPointerCapture(e.pointerId);
});
canvas.addEventListener("pointermove",(e)=>{
  if(!dragging) return;
  const dx=(e.clientX-lastX)/240;
  const dy=(e.clientY-lastY)/240;
  yaw += dx;
  pitch += dy;
  pitch = Math.max(-1.2, Math.min(1.2, pitch));
  lastX=e.clientX; lastY=e.clientY;
});
canvas.addEventListener("pointerup",(e)=>{
  dragging=false;
  try{ canvas.releasePointerCapture(e.pointerId); }catch(_){}
});

function togglePoint(name){
  const m=state.perMission[state.missionIndex];
  m.selectionOps++;

  const idx=selection.points.indexOf(name);
  if(idx>=0) selection.points.splice(idx,1);
  else{
    selection.points.push(name);
    // keep max 4 points
    if(selection.points.length>4) selection.points.shift();
  }
  toast(`–¢–∞“£–¥–∞–ª–¥—ã: ${selection.points.join(", ")}`);
}

/* =========================
   6) ”®–ª—à–µ—É –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞—Å—ã
   ========================= */
function lineFrom2Points(p1,p2){
  const a=scene.pts[p1], b=scene.pts[p2];
  return {p:a, d:sub(b,a)};
}

function planeFrom3Points(p1,p2,p3){
  const A=scene.pts[p1], B=scene.pts[p2], C=scene.pts[p3];
  const n = cross(sub(B,A), sub(C,A));
  return {p:A, n};
}

function angleBetween(u,v){
  const nu=norm(u), nv=norm(v);
  if(nu===0||nv===0) return null;
  let c = dot(u,v)/(nu*nv);
  c = Math.max(-1, Math.min(1,c));
  return Math.acos(c); // radians
}

function angleLinePlane(lineDir, planeNormal){
  // angle between line and plane = 90 - angle(line, normal)
  const a = angleBetween(lineDir, planeNormal);
  if(a===null) return null;
  const theta = Math.PI/2 - a;
  return Math.max(0, theta);
}

function distSkewLines(L1, L2){
  // d = |( (p2-p1) ¬∑ (d1√ód2) )| / |d1√ód2|
  const p1=L1.p, d1=L1.d, p2=L2.p, d2=L2.d;
  const n = cross(d1,d2);
  const nn = norm(n);
  if(nn===0) return null; // parallel or coincident
  const w = sub(p2,p1);
  return Math.abs(dot(w,n))/nn;
}

function radToDeg(r){ return r*180/Math.PI; }

/* =========================
   7) UI: –º–∏—Å—Å–∏—è/—Å—Ü–µ–Ω–∞ –∂“Ø–∫—Ç–µ—É
   ========================= */
const $ = (id)=>document.getElementById(id);

function setScene(key){
  sceneKey=key;
  scene=SCENES[sceneKey]();
  clearSelection();
  renderSceneSelect();
}

function clearSelection(){
  selection.points.length=0;
  selection.plane=null;
  $("measureOut").textContent="–¢–∞“£–¥–∞—É –∂–∞—Å–∞ –¥–∞ –µ—Å–µ–ø—Ç–µ.";
}

function renderSceneSelect(){
  // scenes list tied to mission but allow override
  const sel=$("sceneSelect");
  sel.innerHTML="";
  const opts = [
    ["cube","–ö—É–±"],
    ["rectPrism","–¢—ñ–∫ —Ç”©—Ä—Ç–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞"],
    ["triPrism","“Æ—à–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞"],
    ["sqPyramid","–î“±—Ä—ã—Å —Ç”©—Ä—Ç–±“±—Ä—ã—à—Ç—ã –ø–∏—Ä–∞–º–∏–¥–∞"],
    ["hexPyramid","–î“±—Ä—ã—Å –∞–ª—Ç—ã–±“±—Ä—ã—à—Ç—ã –ø–∏—Ä–∞–º–∏–¥–∞"],
    ["hexPrism","–î“±—Ä—ã—Å –∞–ª—Ç—ã–±“±—Ä—ã—à—Ç—ã –ø—Ä–∏–∑–º–∞"],
    ["cylSketch","–¶–∏–ª–∏–Ω–¥—Ä (—Å—Ö–µ–º–∞)"],
    ["sphereSketch","–®–∞—Ä (—Å—Ö–µ–º–∞)"],
    ["rectPyrSketch","–ü–∏—Ä–∞–º–∏–¥–∞ (—Å—Ö–µ–º–∞)"],
    ["prismSketch","–ü—Ä–∏–∑–º–∞ (–ª–æ–≥–∏–∫–∞)"],
  ];
  opts.forEach(([k,name])=>{
    const o=document.createElement("option");
    o.value=k; o.textContent=name;
    if(k===sceneKey) o.selected=true;
    sel.appendChild(o);
  });
}

function renderMissions(){
  const sel=$("missionSelect");
  sel.innerHTML="";
  MISSIONS.forEach((m,idx)=>{
    const o=document.createElement("option");
    o.value=String(idx);
    o.textContent=m.title;
    sel.appendChild(o);
  });
}

function loadMission(idx){
  state.missionIndex=idx;
  const m=MISSIONS[idx];

  // mission -> scene default
  setScene(m.scene);

  $("missionText").textContent = m.text;
  $("hint1Text").textContent = m.hint1;
  $("hint2Text").textContent = m.hint2;
  $("revealText").textContent = m.reveal;

  $("hintBox1").style.display="none";
  $("hintBox2").style.display="none";
  $("revealBox").style.display="none";

  $("answerInput").value="";
  startTimer();
  renderMeta();
  renderKPIs();
  toast(`–ú–∏—Å—Å–∏—è: ${m.title}`);
}

function renderMeta(){
  const m=state.perMission[state.missionIndex];
  const name=$("studentName").value.trim()||"‚Äî";
  const cls=$("studentClass").value.trim()||"‚Äî";
  $("taskMeta").innerHTML =
    `–û“õ—É—à—ã: <b>${name}</b> ¬∑ –°—ã–Ω—ã–ø: <b>${cls}</b> ¬∑ –£–∞“õ—ã—Ç: <b>${fmt(m.elapsed)}</b> ¬∑ ”ò—Ä–µ–∫–µ—Ç: <b>${m.attempts}</b> ¬∑ “ö–∞—Ç–µ: <b>${m.wrong}</b> ¬∑ –ö”©–º–µ–∫: <b>${(m.usedHint1?1:0)+(m.usedHint2?1:0)}</b> ¬∑ –ë–∞“ì—ã—Ç: <b>${m.revealed?"–ò”ô":"–ñ–æ“õ"}</b> ¬∑ –¢–∞“£–¥–∞—É: <b>${m.selectionOps}</b>`;
}

function renderKPIs(){
  let done=0, wrong=0, hints=0, totalSec=0;
  state.perMission.forEach(x=>{
    done += x.done?1:0;
    wrong += x.wrong;
    hints += (x.usedHint1?1:0)+(x.usedHint2?1:0);
    totalSec += x.elapsed||0;
  });
  $("kpiDone").textContent=done;
  $("kpiWrong").textContent=wrong;
  $("kpiHints").textContent=hints;
  $("kpiTime").textContent=fmt(totalSec);
}

/* =========================
   8) –ï—Å–µ–ø—Ç–µ—É –±–∞—Ç—ã—Ä–º–∞—Å—ã
   ========================= */
function compute(){
  const mode=$("measureMode").value;
  const mstate=state.perMission[state.missionIndex];
  mstate.modeCounts[mode]=(mstate.modeCounts[mode]||0)+1;
  mstate.attempts++;

  // sketch scenes: no geometry
  if(Object.keys(scene.pts).length===0){
    $("measureOut").textContent =
`[–°—Ö–µ–º–∞ —Ä–µ–∂–∏–º—ñ]
–ë“±–ª –º–∏—Å—Å–∏—è–¥–∞ –Ω–∞“õ—Ç—ã 3D ”©–ª—à–µ—É –∂–∞—Å–∞–ª–º–∞–π–¥—ã.
–ö”©–º–µ–∫/–±–∞“ì—ã—Ç –∞—Ä“õ—ã–ª—ã —à–µ—à—ñ–º –∂–æ–ª—ã–Ω –∂–∞–∑.
(–ï—Å–µ–ø –±–µ—Ä—É: ”ô—Ä–µ–∫–µ—Ç/–∫”©–º–µ–∫/—É–∞“õ—ã—Ç –±”ô—Ä—ñ–±—ñ—Ä —Å–∞–Ω–∞–ª–∞–¥—ã.)`;
    toast("–°—Ö–µ–º–∞ –º–∏—Å—Å–∏—è: 3D ”©–ª—à–µ—É –∂–æ“õ");
    renderMeta(); renderKPIs();
    return;
  }

  if(mode==="angleLines"){
    if(selection.points.length<4){
      $("measureOut").textContent="–¢“Ø–∑—É‚Äì—Ç“Ø–∑—É –±“±—Ä—ã—à—ã “Ø—à—ñ–Ω 4 –Ω“Ø–∫—Ç–µ —Ç–∞“£–¥–∞: (P1,P2) –∂”ô–Ω–µ (P3,P4).";
      mstate.wrong++;
      toast("4 –Ω“Ø–∫—Ç–µ –∫–µ—Ä–µ–∫");
      renderMeta(); renderKPIs();
      return;
    }
    const [p1,p2,p3,p4]=selection.points.slice(-4);
    const L1=lineFrom2Points(p1,p2);
    const L2=lineFrom2Points(p3,p4);
    const ang=angleBetween(L1.d,L2.d);
    if(ang===null){ mstate.wrong++; $("measureOut").textContent="–ë—ñ—Ä —Ç“Ø–∑—É –Ω”©–ª –≤–µ–∫—Ç–æ—Ä –±–æ–ª–¥—ã."; }
    else{
      const deg=radToDeg(ang);
      $("measureOut").textContent =
`[–¢“Ø–∑—É‚Äì—Ç“Ø–∑—É]
L1: ${p1}${p2}  –±–∞“ì—ã—Ç—ã: (${L1.d.x.toFixed(3)}, ${L1.d.y.toFixed(3)}, ${L1.d.z.toFixed(3)})
L2: ${p3}${p4}  –±–∞“ì—ã—Ç—ã: (${L2.d.x.toFixed(3)}, ${L2.d.y.toFixed(3)}, ${L2.d.z.toFixed(3)})
–ë“±—Ä—ã—à ‚âà ${deg.toFixed(2)}¬∞`;
      mstate.done=1;
      toast("”®–ª—à–µ–Ω–¥—ñ");
    }
  }

  if(mode==="angleLinePlane"){
    if(selection.points.length<2){
      $("measureOut").textContent="–¢“Ø–∑—É‚Äì–∂–∞–∑—ã“õ—Ç—ã“õ “Ø—à—ñ–Ω –∫–µ–º—ñ 2 –Ω“Ø–∫—Ç–µ (—Ç“Ø–∑—É) —Ç–∞“£–¥–∞.";
      mstate.wrong++;
      toast("2 –Ω“Ø–∫—Ç–µ –∫–µ—Ä–µ–∫");
      renderMeta(); renderKPIs();
      return;
    }
    // choose plane depending on mission/scene defaults:
    // cube missions: use predefined planes; pyramid: SAD etc.
    const mission = MISSIONS[state.missionIndex];
    let planeName=null;
    if(mission.id===4) planeName="BC1D";
    if(mission.id===5) planeName="BCC1";
    if(mission.id===6) planeName="SAD";
    if(mission.id===7) planeName="SAF";
    // fallback: base plane if exists
    if(!planeName){
      planeName = Object.keys(scene.planes)[0] || null;
    }

    // build plane by 3 points
    let pl=null;
    if(planeName && scene.planes[planeName]){
      const [a,b,c]=scene.planes[planeName];
      pl=planeFrom3Points(a,b,c);
    } else {
      // if plane not defined (e.g. SAF in hexPyramid)
      if(planeName==="SAF" && scene.pts["S"] && scene.pts["A"] && scene.pts["F"]){
        pl=planeFrom3Points("S","A","F");
      } else if(planeName==="SAD" && scene.pts["S"] && scene.pts["A"] && scene.pts["D"]){
        pl=planeFrom3Points("S","A","D");
      }
    }

    if(!pl){
      $("measureOut").textContent="–ë“±–ª —Å—Ü–µ–Ω–∞–¥–∞ –∂–∞–∑—ã“õ—Ç—ã“õ –∞–Ω—ã“õ—Ç–∞–ª–º–∞“ì–∞–Ω (Plane missing).";
      mstate.wrong++;
      toast("–ñ–∞–∑—ã“õ—Ç—ã“õ –∂–æ“õ");
      renderMeta(); renderKPIs();
      return;
    }

    const [p1,p2]=selection.points.slice(-2);
    const L=lineFrom2Points(p1,p2);
    const theta=angleLinePlane(L.d, pl.n);
    const deg=radToDeg(theta);
    const n=unit(pl.n);

    $("measureOut").textContent =
`[–¢“Ø–∑—É‚Äì–∂–∞–∑—ã“õ—Ç—ã“õ]
–¢“Ø–∑—É: ${p1}${p2}  –±–∞“ì—ã—Ç—ã: (${L.d.x.toFixed(3)}, ${L.d.y.toFixed(3)}, ${L.d.z.toFixed(3)})
–ñ–∞–∑—ã“õ—Ç—ã“õ: ${planeName}  –Ω–æ—Ä–º–∞–ª—å (–±—ñ—Ä–ª—ñ–∫): (${n.x.toFixed(3)}, ${n.y.toFixed(3)}, ${n.z.toFixed(3)})
–ë“±—Ä—ã—à ‚âà ${deg.toFixed(2)}¬∞`;
    mstate.done=1;
    toast("”®–ª—à–µ–Ω–¥—ñ");
  }

  if(mode==="distSkew"){
    if(selection.points.length<4){
      $("measureOut").textContent="–ê–π“õ–∞—Å —Ç“Ø–∑—É–ª–µ—Ä –∞—Ä–∞“õ–∞—à—ã“õ—Ç—ã“ì—ã “Ø—à—ñ–Ω 4 –Ω“Ø–∫—Ç–µ —Ç–∞“£–¥–∞: (P1,P2) –∂”ô–Ω–µ (P3,P4).";
      mstate.wrong++;
      toast("4 –Ω“Ø–∫—Ç–µ –∫–µ—Ä–µ–∫");
      renderMeta(); renderKPIs();
      return;
    }
    const [p1,p2,p3,p4]=selection.points.slice(-4);
    const L1=lineFrom2Points(p1,p2);
    const L2=lineFrom2Points(p3,p4);
    const d=distSkewLines(L1,L2);
    if(d===null){
      $("measureOut").textContent="–¢“Ø–∑—É–ª–µ—Ä –ø–∞—Ä–∞–ª–ª–µ–ª—å –Ω–µ–º–µ—Å–µ –±–µ—Ç—Ç–µ—Å (–∞–π“õ–∞—Å –µ–º–µ—Å). –ë–∞—Å“õ–∞ –Ω“Ø–∫—Ç–µ —Ç–∞“£–¥–∞.";
      mstate.wrong++;
      toast("–ê–π“õ–∞—Å –µ–º–µ—Å");
    } else {
      $("measureOut").textContent =
`[–ê–π“õ–∞—Å —Ç“Ø–∑—É–ª–µ—Ä –∞—Ä–∞“õ–∞—à—ã“õ—Ç—ã“ì—ã]
L1: ${p1}${p2}
L2: ${p3}${p4}
d ‚âà ${d.toFixed(4)} (–º–æ–¥–µ–ª—å –±—ñ—Ä–ª—ñ–≥—ñ–Ω–¥–µ)`;
      mstate.done=1;
      toast("–ï—Å–µ–ø—Ç–µ–ª–¥—ñ");
    }
  }

  renderMeta();
  renderKPIs();
}

/* =========================
   9) –ï—Å–µ–ø –±–µ—Ä—É
   ========================= */
function buildReport(){
  const name=$("studentName").value.trim()||"–ê—Ç—ã –∂–æ“õ";
  const cls=$("studentClass").value.trim()||"‚Äî";
  let done=0, wrong=0, hints=0, totalSec=0;

  const lines=[];
  lines.push("3D Geometry Mission ‚Äî –ï—Å–µ–ø –±–µ—Ä—É");
  lines.push(`–û“õ—É—à—ã: ${name} | –°—ã–Ω—ã–ø: ${cls}`);
  lines.push("");

  state.perMission.forEach((m,idx)=>{
    totalSec += m.elapsed||0;
    done += m.done?1:0;
    wrong += m.wrong;
    hints += (m.usedHint1?1:0)+(m.usedHint2?1:0);
    lines.push(`- ${MISSIONS[idx].title}`);
    lines.push(`  —É–∞“õ—ã—Ç=${fmt(m.elapsed)} | ”ô—Ä–µ–∫–µ—Ç=${m.attempts} | “õ–∞—Ç–µ=${m.wrong} | –∫”©–º–µ–∫=${(m.usedHint1?1:0)+(m.usedHint2?1:0)} | –±–∞“ì—ã—Ç=${m.revealed?"–∏”ô":"–∂–æ“õ"} | –∞—è“õ—Ç–∞–ª–¥—ã=${m.done?"–∏”ô":"–∂–æ“õ"}`);
  });

  lines.push("");
  lines.push(`“ö–æ—Ä—ã—Ç—ã–Ω–¥—ã: –∞—è“õ—Ç–∞–ª“ì–∞–Ω=${done}/${MISSIONS.length} | “õ–∞—Ç–µ=${wrong} | –∫”©–º–µ–∫=${hints} | –∂–∞–ª–ø—ã —É–∞“õ—ã—Ç=${fmt(totalSec)}`);

  // heuristic focus areas
  const hard = state.perMission
    .map((m,i)=>({i, score:m.wrong + (m.revealed?1:0) + ((m.usedHint1?1:0)+(m.usedHint2?1:0))*0.5}))
    .sort((a,b)=>b.score-a.score)
    .slice(0,3)
    .map(x=>x.i+1);

  lines.push(`“ö–∏—ã–Ω –±–æ–ª“ì–∞–Ω –º–∏—Å—Å–∏—è–ª–∞—Ä: ${hard.join(", ")||"‚Äî"}`);
  lines.push("“∞—Å—ã–Ω—ã—Å: —Ç“Ø–∑—É–ª–µ—Ä –±“±—Ä—ã—à—ã “Ø—à—ñ–Ω –±–∞“ì—ã—Ç—Ç–∞—É—à—ã –≤–µ–∫—Ç–æ—Ä; –∂–∞–∑—ã“õ—Ç—ã“õ “Ø—à—ñ–Ω –Ω–æ—Ä–º–∞–ª—å; –∞–π“õ–∞—Å —Ç“Ø–∑—É–ª–µ—Ä “Ø—à—ñ–Ω u√óv —Ñ–æ—Ä–º—É–ª–∞—Å—ã; –ø—Ä–æ–µ–∫—Ü–∏—è/“õ–∏–º–∞ –∏–¥–µ—è—Å—ã.");
  return lines.join("\n");
}

/* =========================
   10) UI wiring
   ========================= */
(function init(){
  renderMissions();
  renderSceneSelect();

  // also allow scene override
  $("sceneSelect").addEventListener("change", ()=> setScene($("sceneSelect").value));

  $("missionSelect").addEventListener("change", ()=>{
    const idx=Number($("missionSelect").value);
    loadMission(idx);
  });

  $("resetViewBtn").addEventListener("click", ()=>{
    yaw=0.6; pitch=-0.45;
    toast("–ö”©—Ä—ñ–Ω—ñ—Å “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª–¥—ñ");
  });

  $("clearSelectionBtn").addEventListener("click", ()=>{
    clearSelection();
    const ms=state.perMission[state.missionIndex];
    ms.selectionOps++;
    toast("–¢–∞“£–¥–∞—É —Ç–∞–∑–∞—Ä—Ç—ã–ª–¥—ã");
  });

  $("computeBtn").addEventListener("click", compute);

  $("hint1Btn").addEventListener("click", ()=>{
    const m=state.perMission[state.missionIndex];
    m.usedHint1=true;
    $("hintBox1").style.display="block";
    $("hintBox1").open=true;
    toast("–ö”©–º–µ–∫ 1 –∞—à—ã–ª–¥—ã");
    renderMeta(); renderKPIs();
  });

  $("hint2Btn").addEventListener("click", ()=>{
    const m=state.perMission[state.missionIndex];
    m.usedHint2=true;
    $("hintBox2").style.display="block";
    $("hintBox2").open=true;
    toast("–ö”©–º–µ–∫ 2 –∞—à—ã–ª–¥—ã");
    renderMeta(); renderKPIs();
  });

  $("revealBtn").addEventListener("click", ()=>{
    const m=state.perMission[state.missionIndex];
    m.revealed=true;
    $("revealBox").style.display="block";
    $("revealBox").open=true;
    toast("–ë–∞“ì—ã—Ç/–∏–¥–µ—è –∞—à—ã–ª–¥—ã");
    renderMeta(); renderKPIs();
  });

  $("finishBtn").addEventListener("click", ()=>{
    stopTimer();
    alert(buildReport());
    startTimer();
  });

  $("copyReportBtn").addEventListener("click", async ()=>{
    const rep=buildReport();
    try{
      await navigator.clipboard.writeText(rep);
      toast("–ï—Å–µ–ø –±–µ—Ä—É –∫”©—à—ñ—Ä—ñ–ª–¥—ñ");
    }catch(e){
      const ta=document.createElement("textarea");
      ta.value=rep; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy");
      document.body.removeChild(ta);
      toast("–ï—Å–µ–ø –±–µ—Ä—É –∫”©—à—ñ—Ä—ñ–ª–¥—ñ");
    }
  });

  $("clearAllBtn").addEventListener("click", ()=>{
    if(!confirm("–ë–∞—Ä–ª—ã“õ –Ω”ô—Ç–∏–∂–µ–Ω—ñ —Ç–∞–∑–∞—Ä—Ç–∞—Å—ã“£ –±–∞?")) return;
    state.perMission = MISSIONS.map(()=>({
      startedAt:null, elapsed:0,
      attempts:0, wrong:0, done:0,
      usedHint1:false, usedHint2:false, revealed:false,
      modeCounts:{angleLines:0, angleLinePlane:0, distSkew:0},
      selectionOps:0,
    }));
    clearSelection();
    loadMission(0);
    toast("–ë–∞—Ä–ª—ã“ì—ã —Ç–∞–∑–∞—Ä—Ç—ã–ª–¥—ã");
  });

  // start first mission
  $("missionSelect").value="0";
  loadMission(0);

  draw();
})();
</script>
</body>
</html>
