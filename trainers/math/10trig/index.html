<!doctype html>
<html lang="kk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trig Lab KZ (Light) ‚Äî 10 –µ—Å–µ–ø + —Ç–∞–ª–¥–∞—É</title>
  <style>
    :root{
      --bg:#f6f8ff;
      --card:#ffffff;
      --ink:#172048;
      --muted:#55618a;
      --line:rgba(23,32,72,.12);
      --ok:#13b981;
      --bad:#ef476f;
      --warn:#f59e0b;
      --btn:#eef2ff;
      --shadow: 0 14px 34px rgba(22,28,60,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--ink);
      background:
        radial-gradient(900px 600px at 12% 8%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(900px 600px at 88% 14%, rgba(34,197,94,.16), transparent 60%),
        radial-gradient(900px 600px at 50% 92%, rgba(245,158,11,.14), transparent 60%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(246,248,255,.78);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1040px;margin:0 auto;padding:0 16px}
    .top{padding:14px 0; display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted); font-size:13px; margin-top:6px}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; padding:14px 0 28px}
    @media(max-width:950px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92));
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-size:12px;color:var(--muted)}
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(23,32,72,.16);
      background:#fff;
      color:var(--ink);
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .btn{
      cursor:pointer; user-select:none;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(23,32,72,.14);
      background: linear-gradient(180deg, #ffffff, var(--btn));
      color:var(--ink);
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{transform: translateY(-1px); filter:brightness(1.02)}
    .btn:active{transform: translateY(0px); filter:brightness(.99)}
    .btn.ok{border-color:rgba(19,185,129,.40)}
    .btn.bad{border-color:rgba(239,71,111,.40)}
    .pill{
      font-size:12px;
      border:1px solid rgba(23,32,72,.14);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      background:#fff;
    }
    .pill.ok{border-color:rgba(19,185,129,.45); color:rgba(19,185,129,.98)}
    .pill.bad{border-color:rgba(239,71,111,.45); color:rgba(239,71,111,.98)}
    .sep{height:1px;background:var(--line); margin:12px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .muted{color:var(--muted); font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media(max-width:720px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .box{border:1px solid var(--line); border-radius:14px; padding:10px; background:#fff}
    .kpi .n{font-weight:900; font-size:18px; color:var(--ink)}
    .kpi .t{font-size:12px; color:var(--muted)}
    .progress{
      height:10px; border-radius:999px;
      background: rgba(23,32,72,.08);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .bar{height:100%; width:0%; background:linear-gradient(90deg, rgba(19,185,129,.92), rgba(245,158,11,.92))}
    details{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    summary{cursor:pointer}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#fff; border:1px solid var(--line); box-shadow: var(--shadow);
      padding:10px 12px; border-radius:999px; font-size:13px; color:var(--ink);
      display:none; z-index:99;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div>
      <h1>Trig Lab ‚Äî –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è–ª—ã“õ —Ç–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ (10 –µ—Å–µ–ø)</h1>
      <div class="sub">“ö–∞–∑–∞“õ—à–∞ ¬∑ –ê—à—ã“õ —Ñ–æ–Ω ¬∑ –û—Ñ–ª–∞–π–Ω 1 —Ñ–∞–π–ª ¬∑ –°–æ“£—ã–Ω–¥–∞ —Ç–æ–ª—ã“õ —Ç–∞–ª–¥–∞—É (“õ–∞—Ç–µ/–∫”©–º–µ–∫/—É–∞“õ—ã—Ç/”ô—Ä–µ–∫–µ—Ç)</div>
    </div>
    <div style="min-width:240px; width:320px">
      <div class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
      <div class="progress"><div class="bar" id="progressBar"></div></div>
      <div class="small" id="progressText" style="margin-top:6px">0/10</div>
    </div>
  </div>
</header>

<div class="toast" id="toast"></div>

<div class="wrap grid">
  <section class="card">
    <div class="row">
      <div style="flex:1;min-width:220px">
        <label>–û“õ—É—à—ã–Ω—ã“£ –∞—Ç—ã-–∂”©–Ω—ñ</label>
        <input id="studentName" placeholder="–ú—ã—Å–∞–ª—ã: –ê–π–∞—Ä—É" />
      </div>
      <div style="width:140px">
        <label>–°—ã–Ω—ã–ø</label>
        <input id="studentClass" placeholder="10A" />
      </div>
    </div>

    <div class="sep"></div>

    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div style="flex:1;min-width:260px">
        <label>–ï—Å–µ–ø —Ç–∞“£–¥–∞</label>
        <select id="taskSelect"></select>
      </div>
      <div class="row">
        <button class="btn" id="prevBtn">‚óÄ</button>
        <button class="btn" id="nextBtn">‚ñ∂</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="card" style="background:#fff">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><b id="taskTitle">–ï—Å–µ–ø</b></div>
        <div class="row">
          <span class="pill" id="timerPill">‚è± 00:00</span>
          <span class="pill" id="statusPill">”ò–ª—ñ —Ç–µ–∫—Å–µ—Ä—ñ–ª–º–µ–¥—ñ</span>
        </div>
      </div>

      <div class="sep"></div>

      <div id="taskBody" class="mono" style="white-space:pre-wrap; font-size:14px; line-height:1.45"></div>

      <div class="sep"></div>

      <div class="row">
        <div style="flex:1;min-width:220px">
          <label>–°—Ç—Ä–∞—Ç–µ–≥–∏—è</label>
          <select id="strategy">
            <option value="swap">üîÅ –ê—É—ã—Å—Ç—ã—Ä—É</option>
            <option value="identity">üìê –¢–æ–∂–¥–µ—Å—Ç–≤–æ/—Ñ–æ—Ä–º—É–ª–∞</option>
            <option value="algebra">‚öñ –ê–ª–≥–µ–±—Ä–∞–ª—ã“õ —Ç“Ø—Ä–ª–µ–Ω–¥—ñ—Ä—É</option>
            <option value="graph">üìä –ì—Ä–∞—Ñ–∏–∫—Ç—ñ–∫ –æ–π–ª–∞—É</option>
            <option value="domain">üß© –û–î–ó/—à–µ–∫—Ç–µ—É</option>
          </select>
        </div>
        <div style="flex:1;min-width:260px">
          <label>–ñ–∞—É–∞–±—ã“£ (–º—ã—Å: x=..., y=...)</label>
          <input id="answerInput" placeholder="–ú—ã—Å–∞–ª—ã: x=-pi/3+2pi n, y=3" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn ok" id="checkBtn">‚úî –¢–µ–∫—Å–µ—Ä—É</button>
        <button class="btn" id="hint1Btn">üí° –ö”©–º–µ–∫ 1</button>
        <button class="btn" id="hint2Btn">üí° –ö”©–º–µ–∫ 2</button>
        <button class="btn bad" id="revealBtn">üëÅ –®–µ—à—ñ–º–¥—ñ –∞—à—É</button>
        <button class="btn" id="resetTaskBtn">‚Ü∫ –û—Å—ã –µ—Å–µ–ø—Ç—ñ “õ–∞–π—Ç–∞ –±–∞—Å—Ç–∞—É</button>
      </div>

      <div class="sep"></div>

      <details id="hintBox1" style="display:none">
        <summary>–ö”©–º–µ–∫ 1</summary>
        <div class="small" id="hint1Text"></div>
      </details>

      <details id="hintBox2" style="display:none;margin-top:10px">
        <summary>–ö”©–º–µ–∫ 2</summary>
        <div class="small" id="hint2Text"></div>
      </details>

      <details id="solutionBox" style="display:none;margin-top:10px">
        <summary>–î“±—Ä—ã—Å –∂–∞—É–∞–ø (–∫—ñ–ª—Ç)</summary>
        <div class="small mono" id="solutionText" style="white-space:pre-wrap"></div>
      </details>

      <div class="sep"></div>
      <div class="small" id="taskMeta"></div>
    </div>

    <div class="sep"></div>

    <div class="row" style="justify-content:space-between">
      <button class="btn" id="finishBtn">üìä –°–∞–±–∞“õ—Ç—ã –∞—è“õ—Ç–∞—É ¬∑ –¢–∞–ª–¥–∞—É</button>
      <button class="btn" id="copyReportBtn">üßæ –ï—Å–µ–ø—Ç—ñ –∫”©—à—ñ—Ä—É</button>
      <button class="btn" id="clearAllBtn">üóë –ë–∞—Ä–ª—ã“ì—ã–Ω —Ç–∞–∑–∞—Ä—Ç—É</button>
    </div>
  </section>

  <aside class="card">
    <b>“ö—ã—Å“õ–∞ —Ç–∞–ª–¥–∞—É</b>
    <div class="sep"></div>
    <div class="kpi">
      <div class="box"><div class="n" id="kpiCorrect">0</div><div class="t">–î“±—Ä—ã—Å (–µ—Å–µ–ø —Å–∞–Ω—ã)</div></div>
      <div class="box"><div class="n" id="kpiWrong">0</div><div class="t">“ö–∞—Ç–µ (”ô—Ä–µ–∫–µ—Ç)</div></div>
      <div class="box"><div class="n" id="kpiHints">0</div><div class="t">–ö”©–º–µ–∫ —Å–∞–Ω—ã</div></div>
      <div class="box"><div class="n" id="kpiReveal">0</div><div class="t">–®–µ—à—ñ–º –∞—à—ã–ª–¥—ã</div></div>
    </div>

    <div class="sep"></div>

    <b>–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∂–∏—ñ–ª—ñ–≥—ñ</b>
    <div class="small" id="strategyStats" style="margin-top:8px"></div>

    <div class="sep"></div>

    <b>–ñ–∏—ñ “õ–∞—Ç–µ –±–æ–ª“ì–∞–Ω –µ—Å–µ–ø—Ç–µ—Ä</b>
    <div class="small" id="hotTasks" style="margin-top:8px"></div>

    <div class="sep"></div>

    <b>–ï–Ω–≥—ñ–∑—É “Ø–ª–≥—ñ–ª–µ—Ä—ñ</b>
    <div class="small mono" style="white-space:pre-wrap;margin-top:8px">
x=-pi/3+2pi n, y=3
x=2pi n, y=3
x=-pi/2+2pi m, y=2
x=3*sqrt(3), y=pi/3+pi n
    </div>
  </aside>
</div>

<script>
/* =========================
   0) 10 –ï—Å–µ–ø + –∫”©–º–µ–∫ –º”ô—Ç—ñ–Ω–¥–µ—Ä—ñ
   ========================= */
const TASKS = [
  {
    id: 1,
    title: "–ï—Å–µ–ø 1",
    body:
`–¢–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ–Ω —à–µ—à:
{ 16^{cosx} ‚àí 10¬∑4^{cosx} + 16 = 0
  ‚àöy + 2sinx = 0 }`,
    hint1: "16^{cosx}=(4^{cosx})^2. t=4^{cosx} –∞—É—ã—Å—Ç—ã—Ä—É—ã–Ω “õ–æ–ª–¥–∞–Ω.",
    hint2: "t^2‚àí10t+16=0 ‚Üí t. –°–æ—Å—ã–Ω cosx –∂”ô–Ω–µ ‚àöy‚â•0 —à–∞—Ä—Ç—ã–Ω “±–º—ã—Ç–ø–∞.",
    sol:  "x=-pi/3+2pi n; y=3",
  },
  {
    id: 2,
    title: "–ï—Å–µ–ø 2",
    body:
`–¢–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ–Ω —à–µ—à:
{ sinx = y ‚àí 3
  cosx = y ‚àí 2 }`,
    hint1: "sin¬≤x+cos¬≤x=1 —Ç–æ–∂–¥–µ—Å—Ç–≤–æ—Å—ã–Ω “õ–æ–ª–¥–∞–Ω.",
    hint2: "(y‚àí3)¬≤+(y‚àí2)¬≤=1 ‚Üí y —Ç–∞–±–∞—Å—ã“£, —Å–æ—Å—ã–Ω x.",
    sol:  "1) x=2pi n; y=3  ||  2) x=-pi/2+2pi m; y=2",
  },
  {
    id: 3,
    title: "–ï—Å–µ–ø 3",
    body:
`–¢–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ–Ω —à–µ—à:
{ 2^x = siny
  2^{‚àíx} = 2siny + 1 }`,
    hint1: "t=2^x>0, 2^{‚àíx}=1/t –¥–µ–ø –∂–∞–∑.",
    hint2: "t=siny, 1/t=2t+1 ‚Üí t. –°–æ“£—ã–Ω–¥–∞ siny=t.",
    sol:  "x=-1; y=(-1)^n*pi/6 + pi n",
  },
  {
    id: 4,
    title: "–ï—Å–µ–ø 4",
    body:
`–¢–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ–Ω —à–µ—à:
{ 2sin^2y + 3siny ‚àí 2 = 0
  ‚àö(x^2 ‚àí x + 4cosy) = 0 }`,
    hint1: "t=siny: 2t^2+3t‚àí2=0.",
    hint2: "‚àöA=0 ‚áí A=0: x^2‚àíx+4cosy=0.",
    sol:  "1) x=-3; y=5pi/6+2pi n  ||  2) x=4; y=5pi/6+2pi m",
  },
  {
    id: 5,
    title: "–ï—Å–µ–ø 5",
    body:
`–¢–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ–Ω —à–µ—à:
{ 3^y + 2cosx = 0
  2sin^2x ‚àí 3sinx ‚àí 2 = 0 }`,
    hint1: "t=sinx –∞—Ä“õ—ã–ª—ã –∫–≤–∞–¥—Ä–∞—Ç —Ç–µ“£–¥–µ—É.",
    hint2: "3^y>0 ‚áí cosx<0 —à–∞—Ä—Ç—ã–Ω –º—ñ–Ω–¥–µ—Ç—Ç—ñ —Ç–µ–∫—Å–µ—Ä.",
    sol:  "x=-5pi/6+2pi n; y=1/2",
  },
  {
    id: 6,
    title: "–ï—Å–µ–ø 6",
    body:
`–¢–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ–Ω —à–µ—à:
{ x^2 = 8siny + 1
  x + 1 = 2siny }`,
    hint1: "siny=(x+1)/2.",
    hint2: "–û–Ω—ã x^2=8siny+1 —Ç–µ“£–¥–µ—É—ñ–Ω–µ “õ–æ–π.",
    sol:  "x=-1; y=n*pi",
  },
  {
    id: 7,
    title: "–ï—Å–µ–ø 7",
    body:
`–¢–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ–Ω —à–µ—à:
{ cosy¬∑‚àö(sinx) = 0
  2sin^2x = 2cos^2x + 1 }`,
    hint1: "cosy=0 –Ω–µ–º–µ—Å–µ sinx=0 (–∂”ô–Ω–µ sinx‚â•0).",
    hint2: "2(sin¬≤x‚àícos¬≤x)=1 ‚áí ‚àí2cos2x=1.",
    sol:  "x=(-1)^n*pi/3 + n*pi; y=pi/2 + pi k",
  },
  {
    id: 8,
    title: "–ï—Å–µ–ø 8",
    body:
`–¢–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ–Ω —à–µ—à:
{ 4cos^2x ‚àí 4cosx ‚àí 3 = 0
  ‚àö(y^2 ‚àí y ‚àí 3) + 2cosx = 0 }`,
    hint1: "t=cosx –∞—Ä“õ—ã–ª—ã 4t^2‚àí4t‚àí3=0.",
    hint2: "‚àö(...)‚â•0 ‚áí ‚àí2cosx‚â•0 ‚áí cosx‚â§0.",
    sol:  "1) x=-2pi/3+2pi n; y=3  ||  2) x=-2pi/3+2pi m; y=-2",
  },
  {
    id: 9,
    title: "–ï—Å–µ–ø 9",
    body:
`–¢–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ–Ω —à–µ—à:
{ cos2y = cosy
  ‚àö(x^2 ‚àí 2x) = 2siny }`,
    hint1: "cos2y‚àícosy=0 ‚Üí —Ñ–æ—Ä–º—É–ª–∞/–∂—ñ–∫—Ç–µ—É.",
    hint2: "‚àö(...)‚â•0 ‚áí siny‚â•0 –∂”ô–Ω–µ x(x‚àí2)‚â•0 —à–∞—Ä—Ç—Ç–∞—Ä—ã–Ω “±–º—ã—Ç–ø–∞.",
    sol:
`4 —à–µ—à—ñ–º –∂“±–±—ã:
1) x=0,  y=2pi n
2) x=2,  y=2pi m
3) x=3,  y=2pi/3 + 2pi k
4) x=-1, y=2pi/3 + 2pi l`,
  },
  {
    id: 10,
    title: "–ï—Å–µ–ø 10",
    body:
`–¢–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ–Ω —à–µ—à:
{ x¬∑tg y = 9
  x¬∑ctg y = 3 }`,
    hint1: "–ö”©–±–µ–π—Ç—É: x¬≤¬∑tg y¬∑ctg y=27.",
    hint2: "tg¬∑ctg=1 ‚áí x=¬±3‚àö3, tg y=9/x.",
    sol:  "1) x=3*sqrt(3); y=pi/3+pi n  ||  2) x=-3*sqrt(3); y=-pi/3+pi m",
  },
];

/* =========================
   1) –ñ–∞—É–∞–ø –∫—ñ–ª—Ç—ñ: X –∂”ô–Ω–µ Y –±”©–ª–µ–∫ —Ç–µ–∫—Å–µ—Ä—ñ–ª–µ–¥—ñ (–∫”©–ø —à–µ—à—ñ–º –±–æ–ª—Å–∞ ‚Äî –∫–µ–∑ –∫–µ–ª–≥–µ–Ω—ñ–Ω “õ–∞–±—ã–ª–¥–∞–π–¥—ã)
   –ï–ù–ì–Ü–ó–£: x=..., y=... (–∫–µ–∑ –∫–µ–ª–≥–µ–Ω —Ä–µ—Ç–ø–µ–Ω –±–æ–ª–∞–¥—ã)
   ========================= */
const ANSWER_KEYS = [
  // 1
  { sets: [
      { x: /x=-(pi|œÄ)\/3\+2(pi|œÄ)n/, y: /y=3/ }
    ] },
  // 2
  { sets: [
      { x: /x=2(pi|œÄ)n/, y: /y=3/ },
      { x: /x=-(pi|œÄ)\/2\+2(pi|œÄ)m/, y: /y=2/ }
    ] },
  // 3
  { sets: [
      { x: /x=-1/, y: /y=\(\-?1\)\^n\*(pi|œÄ)\/6\+(pi|œÄ)n|y=\(\-1\)\^n\*(pi|œÄ)\/6\+(pi|œÄ)n|y=\(\-1\)\^n\*(pi|œÄ)\/6\+(pi|œÄ)n/ }
    ] },
  // 4
  { sets: [
      { x: /x=-3/, y: /y=5(pi|œÄ)\/6\+2(pi|œÄ)n/ },
      { x: /x=4/,  y: /y=5(pi|œÄ)\/6\+2(pi|œÄ)m/ }
    ] },
  // 5
  { sets: [
      { x: /x=-5(pi|œÄ)\/6\+2(pi|œÄ)n/, y: /y=1\/2|y=0\.5/ }
    ] },
  // 6
  { sets: [
      { x: /x=-1/, y: /y=(pi|œÄ)n|y=n\*(pi|œÄ)/ }
    ] },
  // 7
  { sets: [
      { x: /x=\(\-1\)\^n\*(pi|œÄ)\/3\+n\*(pi|œÄ)|x=\(\-1\)\^n\*(pi|œÄ)\/3\+n(pi|œÄ)|x=\(\-1\)\^n(pi|œÄ)\/3\+n(pi|œÄ)/,
        y: /y=(pi|œÄ)\/2\+(pi|œÄ)k|y=(pi|œÄ)\/2\+k\*(pi|œÄ)/ }
    ] },
  // 8
  { sets: [
      { x: /x=-2(pi|œÄ)\/3\+2(pi|œÄ)n/, y: /y=3/ },
      { x: /x=-2(pi|œÄ)\/3\+2(pi|œÄ)m/, y: /y=-2/ }
    ] },
  // 9 (4 –∂“±–ø—Ç—ã“£ –∫–µ–∑ –∫–µ–ª–≥–µ–Ω—ñ)
  { sets: [
      { x: /x=0/,  y: /y=2(pi|œÄ)n/ },
      { x: /x=2/,  y: /y=2(pi|œÄ)m/ },
      { x: /x=3/,  y: /y=2(pi|œÄ)\/3\+2(pi|œÄ)k/ },
      { x: /x=-1/, y: /y=2(pi|œÄ)\/3\+2(pi|œÄ)l/ }
    ] },
  // 10
  { sets: [
      { x: /x=3\*sqrt\(3\)|x=3sqrt\(3\)|x=3‚àö3/, y: /y=(pi|œÄ)\/3\+(pi|œÄ)n|y=(pi|œÄ)\/3\+n\*(pi|œÄ)/ },
      { x: /x=-3\*sqrt\(3\)|x=-3sqrt\(3\)|x=-3‚àö3/, y: /y=-(pi|œÄ)\/3\+(pi|œÄ)m|y=-(pi|œÄ)\/3\+m\*(pi|œÄ)/ }
    ] },
];

/* =========================
   2) –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∂”ô–Ω–µ —Ç–µ–∫—Å–µ—Ä—É
   ========================= */
function normalize(s){
  return (s||"")
    .toLowerCase()
    .replaceAll(" ", "")
    .replaceAll("‚àí","-")
    .replaceAll("√ó","*")
    .replaceAll("¬∑","*")
    .replaceAll("tg","tan")
    .replaceAll("ctg","cot")
    .replaceAll("pi", "pi") // just keep
    ;
}

function extractXY(text){
  const t = normalize(text);
  // x=... –∂”ô–Ω–µ y=... –∫–µ–∑ –∫–µ–ª–≥–µ–Ω —Ä–µ—Ç–ø–µ–Ω
  const mx = t.match(/x=([^,;]+)/);
  const my = t.match(/y=([^,;]+)/);
  return {t, x: mx ? "x="+mx[1] : "", y: my ? "y="+my[1] : ""};
}

function checkAnswer(taskIndex, userText){
  const key = ANSWER_KEYS[taskIndex];
  const {t, x, y} = extractXY(userText);

  if(!x || !y){
    return {ok:false, msg:"–ñ–∞—É–∞–ø—Ç—ã –æ—Å—ã–ª–∞–π –µ–Ω–≥—ñ–∑: x=..., y=... (“Ø—Ç—ñ—Ä –∞—Ä“õ—ã–ª—ã)."};
  }
  // –∫–µ–∑ –∫–µ–ª–≥–µ–Ω —à–µ—à—ñ–º –∂–∏—ã–Ω—ã–Ω “õ–∞–±—ã–ª–¥–∞–π–¥—ã
  for(const s of key.sets){
    if(s.x.test(x) && s.y.test(y)) return {ok:true, msg:"–î“±—Ä—ã—Å! ‚úÖ"};
    // –∫–µ–π–¥–µ –æ“õ—É—à—ã x/y –æ—Ä–Ω—ã–Ω –∞—É—ã—Å—Ç—ã—Ä—ã–ø –∂–∞–∑—É—ã –º“Ø–º–∫—ñ–Ω ‚Äî “õ–∞—É—ñ–ø—Å—ñ–∑–¥—ñ–∫ “Ø—à—ñ–Ω —Ç–æ–ª—ã“õ –º”ô—Ç—ñ–Ω–Ω–µ–Ω –¥–µ —Ç–µ–∫—Å–µ—Ä–µ–º—ñ–∑
    if(s.x.test(t) && s.y.test(t)) return {ok:true, msg:"–î“±—Ä—ã—Å! ‚úÖ"};
  }
  return {ok:false, msg:"“ö–∞—Ç–µ. –§–æ—Ä–º–∞–Ω—ã –∂”ô–Ω–µ n,m,k,l –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–Ω –¥“±—Ä—ã—Å –∂–∞–∑“ì–∞–Ω—ã“£–¥—ã —Ç–µ–∫—Å–µ—Ä."};
}

/* =========================
   3) –ü—Ä–æ–≥—Ä–µ—Å—Å/–ª–æ–≥–∏–∫–∞
   ========================= */
const state = {
  current: 0,
  perTask: TASKS.map(()=>({
    startedAt: null,
    elapsed: 0,
    attempts: 0,
    wrong: 0,
    correct: 0,
    usedHint1: false,
    usedHint2: false,
    revealed: false,
    strategyCounts: {swap:0, identity:0, algebra:0, graph:0, domain:0},
    lastCheck: null,
  })),
};

let timer = null;
const $ = (id)=>document.getElementById(id);

function toast(msg){
  const el = $("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> el.style.display="none", 2200);
}

function fmtTime(sec){
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(Math.floor(sec%60)).padStart(2,"0");
  return `${m}:${s}`;
}

function startTimer(){
  stopTimer();
  timer = setInterval(()=>{
    const t = state.perTask[state.current];
    if(!t.startedAt) t.startedAt = Date.now();
    t.elapsed = Math.floor((Date.now() - t.startedAt)/1000);
    $("timerPill").textContent = `‚è± ${fmtTime(t.elapsed)}`;
  }, 250);
}
function stopTimer(){ if(timer) clearInterval(timer); timer=null; }

function loadTask(i){
  state.current = i;
  const task = TASKS[i];

  $("taskTitle").textContent = `${task.title}`;
  $("taskBody").textContent = task.body;

  $("hintBox1").style.display = "none";
  $("hintBox2").style.display = "none";
  $("solutionBox").style.display = "none";

  $("hint1Text").textContent = task.hint1;
  $("hint2Text").textContent = task.hint2;
  $("solutionText").textContent = task.sol;

  $("answerInput").value = "";

  const t = state.perTask[i];
  if(!t.startedAt) t.startedAt = Date.now();

  startTimer();
  renderMeta();
  renderSidebar();
}

function renderMeta(){
  const t = state.perTask[state.current];
  $("taskMeta").innerHTML =
    `”ò—Ä–µ–∫–µ—Ç: <b>${t.attempts}</b> ¬∑ “ö–∞—Ç–µ: <b>${t.wrong}</b> ¬∑ –ö”©–º–µ–∫: <b>${(t.usedHint1?1:0)+(t.usedHint2?1:0)}</b> ¬∑ –®–µ—à—ñ–º –∞—à—ã–ª–¥—ã: <b>${t.revealed?"–ò”ô":"–ñ–æ“õ"}</b>`;
}

function calcTotals(){
  let correct=0, wrong=0, hints=0, reveals=0;
  const strategyCounts = {swap:0, identity:0, algebra:0, graph:0, domain:0};
  state.perTask.forEach(t=>{
    correct += (t.correct>0)?1:0;
    wrong += t.wrong;
    hints += (t.usedHint1?1:0) + (t.usedHint2?1:0);
    reveals += (t.revealed?1:0);
    for(const k in strategyCounts) strategyCounts[k]+=t.strategyCounts[k]||0;
  });
  return {correct, wrong, hints, reveals, strategyCounts};
}

function renderSidebar(){
  const totals = calcTotals();
  $("kpiCorrect").textContent = totals.correct;
  $("kpiWrong").textContent = totals.wrong;
  $("kpiHints").textContent = totals.hints;
  $("kpiReveal").textContent = totals.reveals;

  $("progressBar").style.width = `${(totals.correct/10)*100}%`;
  $("progressText").textContent = `${totals.correct}/10`;

  const map = {
    swap:"üîÅ –ê—É—ã—Å—Ç—ã—Ä—É",
    identity:"üìê –¢–æ–∂–¥–µ—Å—Ç–≤–æ",
    algebra:"‚öñ –ê–ª–≥–µ–±—Ä–∞",
    graph:"üìä –ì—Ä–∞—Ñ–∏–∫",
    domain:"üß© –û–î–ó",
  };
  $("strategyStats").innerHTML =
    Object.keys(totals.strategyCounts).map(k=>`${map[k]}: <b>${totals.strategyCounts[k]}</b>`).join("<br>");

  const hot = state.perTask
    .map((t,idx)=>({idx, wrong:t.wrong, attempts:t.attempts}))
    .sort((a,b)=>b.wrong-a.wrong)
    .slice(0,3)
    .filter(x=>x.wrong>0);

  $("hotTasks").innerHTML = hot.length
    ? hot.map(h=>`–ï—Å–µ–ø ${h.idx+1}: “õ–∞—Ç–µ <b>${h.wrong}</b> (”ô—Ä–µ–∫–µ—Ç ${h.attempts})`).join("<br>")
    : "”ò–∑—ñ—Ä—à–µ “õ–∞—Ç–µ –∂–æ“õ.";

  // status pill
  const cur = state.perTask[state.current];
  if(cur.lastCheck && cur.lastCheck.ok===true){
    $("statusPill").className = "pill ok";
    $("statusPill").textContent = "‚úî –î“±—Ä—ã—Å";
  } else if(cur.lastCheck && cur.lastCheck.ok===false){
    $("statusPill").className = "pill bad";
    $("statusPill").textContent = "‚úñ “ö–∞—Ç–µ";
  } else {
    $("statusPill").className = "pill";
    $("statusPill").textContent = "”ò–ª—ñ —Ç–µ–∫—Å–µ—Ä—ñ–ª–º–µ–¥—ñ";
  }
}

function buildReport(){
  const name = $("studentName").value.trim() || "–ê—Ç—ã –∂–æ“õ";
  const cls = $("studentClass").value.trim() || "‚Äî";
  const totals = calcTotals();
  const lines = [];
  lines.push(`Trig Lab –µ—Å–µ–±—ñ`);
  lines.push(`–û“õ—É—à—ã: ${name} | –°—ã–Ω—ã–ø: ${cls}`);
  lines.push(`–î“±—Ä—ã—Å –∞—è“õ—Ç–∞–ª“ì–∞–Ω –µ—Å–µ–ø—Ç–µ—Ä: ${totals.correct}/10`);
  lines.push(`–ñ–∞–ª–ø—ã “õ–∞—Ç–µ —Å–∞–Ω—ã: ${totals.wrong}`);
  lines.push(`–ö”©–º–µ–∫ “õ–æ–ª–¥–∞–Ω—É: ${totals.hints}`);
  lines.push(`–®–µ—à—ñ–º –∞—à—ã–ª“ì–∞–Ω: ${totals.reveals}`);
  lines.push(``);
  lines.push(`–ï—Å–µ–ø—Ç–µ—Ä –±–æ–π—ã–Ω—à–∞:`);
  state.perTask.forEach((t,idx)=>{
    const done = t.correct>0 ? "‚úî" : "‚Äî";
    const h = (t.usedHint1?1:0)+(t.usedHint2?1:0);
    lines.push(`- –ï—Å–µ–ø ${idx+1}: ${done} | ”ô—Ä–µ–∫–µ—Ç=${t.attempts} | “õ–∞—Ç–µ=${t.wrong} | –∫”©–º–µ–∫=${h} | —à–µ—à—ñ–º=${t.revealed?"–∏”ô":"–∂–æ“õ"} | —É–∞“õ—ã—Ç=${fmtTime(t.elapsed)}`);
  });

  // –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: “õ–∏—ã–Ω –µ—Å–µ–ø—Ç–µ—Ä
  const hardest = state.perTask
    .map((t,i)=>({i, score:t.wrong + (t.revealed?1:0) + ((t.usedHint1?1:0)+(t.usedHint2?1:0))*0.5}))
    .sort((a,b)=>b.score-a.score)
    .slice(0,3);

  lines.push(``);
  lines.push(`–ò–ò-“õ–æ—Ä—ã—Ç—ã–Ω–¥—ã (—ç–≤—Ä–∏—Å—Ç–∏–∫–∞):`);
  if(totals.correct>=8) lines.push(`- –î–µ“£–≥–µ–π: –ñ–æ“ì–∞—Ä—ã.`);
  else if(totals.correct>=5) lines.push(`- –î–µ“£–≥–µ–π: –û—Ä—Ç–∞.`);
  else lines.push(`- –î–µ“£–≥–µ–π: –ë–∞—Å—Ç–∞–ø“õ—ã.`);

  lines.push(`- “ö–∏—ã–Ω –±–æ–ª“ì–∞–Ω –µ—Å–µ–ø—Ç–µ—Ä: ${hardest.map(x=>x.i+1).join(", ")}`);
  lines.push(`- “∞—Å—ã–Ω—ã—Å: —Ç–æ–∂–¥–µ—Å—Ç–≤–æ–ª–∞—Ä–¥—ã –∂“Ø–π–µ–ª–µ—É, –û–î–ó —à–∞—Ä—Ç—Ç–∞—Ä—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä–ª—ñ–∫ (n,m,k,l) –∂–∞–∑—ã–ª—ã–º—ã–Ω –Ω–∞“õ—Ç—ã–ª–∞—É.`);
  return lines.join("\n");
}

/* =========================
   4) UI wiring
   ========================= */
(function init(){
  const sel = $("taskSelect");
  TASKS.forEach((t,i)=>{
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `${t.id}) ${t.title}`;
    sel.appendChild(opt);
  });

  sel.addEventListener("change", ()=> loadTask(Number(sel.value)));
  $("prevBtn").addEventListener("click", ()=> loadTask((state.current+TASKS.length-1)%TASKS.length));
  $("nextBtn").addEventListener("click", ()=> loadTask((state.current+1)%TASKS.length));

  $("hint1Btn").addEventListener("click", ()=>{
    const t = state.perTask[state.current];
    t.usedHint1 = true;
    $("hintBox1").style.display = "block";
    $("hintBox1").open = true;
    toast("–ö”©–º–µ–∫ 1 –∞—à—ã–ª–¥—ã");
    renderMeta(); renderSidebar();
  });
  $("hint2Btn").addEventListener("click", ()=>{
    const t = state.perTask[state.current];
    t.usedHint2 = true;
    $("hintBox2").style.display = "block";
    $("hintBox2").open = true;
    toast("–ö”©–º–µ–∫ 2 –∞—à—ã–ª–¥—ã");
    renderMeta(); renderSidebar();
  });
  $("revealBtn").addEventListener("click", ()=>{
    const t = state.perTask[state.current];
    t.revealed = true;
    $("solutionBox").style.display = "block";
    $("solutionBox").open = true;
    toast("–î“±—Ä—ã—Å –∂–∞—É–∞–ø –∞—à—ã–ª–¥—ã");
    renderMeta(); renderSidebar();
  });

  $("checkBtn").addEventListener("click", ()=>{
    const t = state.perTask[state.current];
    const strat = $("strategy").value;
    t.strategyCounts[strat] = (t.strategyCounts[strat]||0)+1;

    t.attempts++;
    const ans = $("answerInput").value.trim();
    const res = checkAnswer(state.current, ans);
    t.lastCheck = res;

    if(res.ok === true){
      t.correct = 1;
      toast("–î“±—Ä—ã—Å ‚úÖ");
    } else {
      t.wrong++;
      toast("“ö–∞—Ç–µ ‚ùå");
    }
    renderMeta(); renderSidebar();
  });

  $("resetTaskBtn").addEventListener("click", ()=>{
    const idx = state.current;
    state.perTask[idx] = {
      startedAt: Date.now(),
      elapsed: 0,
      attempts: 0,
      wrong: 0,
      correct: 0,
      usedHint1: false,
      usedHint2: false,
      revealed: false,
      strategyCounts: {swap:0, identity:0, algebra:0, graph:0, domain:0},
      lastCheck: null,
    };
    loadTask(idx);
    toast("–û—Å—ã –µ—Å–µ–ø “õ–∞–π—Ç–∞ –±–∞—Å—Ç–∞–ª–¥—ã");
  });

  $("finishBtn").addEventListener("click", ()=>{
    stopTimer();
    alert(buildReport());
  });

  $("copyReportBtn").addEventListener("click", async ()=>{
    const rep = buildReport();
    try{
      await navigator.clipboard.writeText(rep);
      toast("–ï—Å–µ–ø –∫”©—à—ñ—Ä—ñ–ª–¥—ñ");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = rep; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy");
      document.body.removeChild(ta);
      toast("–ï—Å–µ–ø –∫”©—à—ñ—Ä—ñ–ª–¥—ñ");
    }
  });

  $("clearAllBtn").addEventListener("click", ()=>{
    if(!confirm("–ë–∞—Ä–ª—ã“õ –Ω”ô—Ç–∏–∂–µ–Ω—ñ —Ç–∞–∑–∞—Ä—Ç–∞—Å—ã“£ –±–∞?")) return;
    state.perTask = TASKS.map(()=>({
      startedAt: null, elapsed: 0, attempts: 0, wrong: 0, correct: 0,
      usedHint1:false, usedHint2:false, revealed:false,
      strategyCounts:{swap:0, identity:0, algebra:0, graph:0, domain:0},
      lastCheck:null
    }));
    loadTask(0);
    toast("–ë–∞—Ä–ª—ã“ì—ã —Ç–∞–∑–∞—Ä—Ç—ã–ª–¥—ã");
  });

  loadTask(0);
})();
</script>
</body>
</html>
